---
inclusion: always
---
# 项目核心开发准则 (first_of_all)

**目标**: 确保项目代码的一致性、可维护性、健壮性和高效性。所有开发活动应首要遵循以下准则。

## 一、配置管理

1.  **禁止硬编码**:
    *   **规则**: 严禁在代码中硬编码任何可配置的参数、路径、API密钥、默认值等。
    *   **实践**: 必须使用统一的配置文件 (`config.yaml` 或类似)，并通过 `src/utils/config_loader.py` 模块加载配置。
    *   **理由**: 提高配置的灵活性和安全性，便于不同环境的部署和维护。

## 二、并发与异步处理

1.  **统一线程池**:
    *   **规则**: 所有AI分析任务和爬虫任务中的并发或异步操作，必须使用项目提供的标准线程池实现。
    *   **实践**: 使用 `src/utils/thread_pool.py`中的 `AdaptiveThreadPool` (通过 `get_thread_pool()` 获取)。
    *   **理由**: 保证线程安全，统一管理并发资源，便于性能调优和问题排查，避免资源竞争和滥用。

## 三、代码复用与模块化

1.  **优先使用现有工具**:
    *   **规则**: 在实现新功能前，务必检查 `src/utils/` 目录下是否已有可复用的工具类或函数。
    *   **实践**: 熟悉 `utils` 中的各个模块的功能 (如 `config_loader`, `thread_pool`, `colored_logger`, `metadata_manager`, `metadata_utils` 等)。
    *   **理由**: 减少代码冗余，提高开发效率，确保核心逻辑的一致性。

2.  **谨慎新建文件和方法**:
    *   **规则**:
        *   **文件**: 除非有明确、充分的理由并得到架构师或团队确认，否则不要轻易在 `utils` 或核心模块下创建新 `.py` 文件。优先考虑在现有相关模块中扩展。
        *   **方法/函数**: 在向现有类或模块添加新方法前，仔细评估其必要性。确保新方法提供的功能在现有代码框架中确实缺失，且与模块/类的职责一致。
    *   **实践**: 若确需新增，应与团队讨论其设计的合理性和放置位置。
    *   **理由**: 保持项目结构的清晰和精简，避免模块功能发散和代码组织混乱。

3.  **单一职责原则 (类)**:
    *   **规则**: 一个 `.py` 文件应主要包含一个核心类（或一组高度相关的辅助类/函数，但主要焦点是一个类）。
    *   **实践**: 避免在一个文件中定义多个不相关或职责分散的类。
    *   **理由**: 提高代码的内聚性、可读性和可维护性，便于单元测试。

## 四、日志管理

1.  **统一日志输出**:
    *   **规则**: 项目中所有模块的日志输出，必须使用统一的日志处理模块。
    *   **实践**: 通过 `src/utils/colored_logger.py` (通常是 `setup_colored_logging()` 初始化后，直接使用 `logging.getLogger(__name__)`) 进行日志记录。
    *   **理由**: 保证日志格式和输出目的地的一致性，便于日志的集中管理、分析和问题追踪。利用彩色日志提高开发阶段的可读性。

## 五、元数据操作

1.  **标准元数据管理**:
    *   **规则**: 所有对 `crawler_metadata.json` 和 `analysis_metadata.json` 的读写操作，必须通过标准的元数据管理工具。
    *   **实践**:
        *   使用 `src/utils/metadata_manager.py`中的 `MetadataManager` 类作为主要入口。
        *   可直接或间接使用 `src/utils/metadata_utils.py` 中的 `load_metadata` 和 `save_metadata` 函数（通常由 `MetadataManager` 内部调用）。
    *   **理由**: 确保元数据操作的线程安全、数据一致性和原子性。

2.  **元数据一致性与适配**:
    *   **规则**:
        *   爬虫模块 (`src/crawlers/`) 生成爬虫元数据时，其结构和字段需严格遵守 `metadata_architecture.mdc` 中定义的规范。
        *   AI分析模块 (`src/ai_analyzer/`) 生成或更新分析元数据时，同样需遵循规范。
        *   `src/utils/rebuild_metadata.py` 脚本在重建元数据时，其解析、生成和更新逻辑必须与爬虫及AI模块生成元数据的方式保持双向兼容和一致。
    *   **实践**: 开发或修改涉及元数据操作的功能时，务必参考 `metadata_architecture.mdc`，并考虑对 `rebuild_metadata.py` 的潜在影响。
    *   **理由**: 保证元数据在整个项目生命周期中的完整性和可用性，避免因格式或逻辑不一致导致的数据处理错误。

## 六、通用编码规范

1.  **代码清晰度与可读性**:
    *   编写易于理解和维护的代码。使用有意义的变量名和函数名。
    *   适度添加注释，特别是对复杂逻辑或重要决策进行说明。避免冗余或解释显而易见代码的注释。
2.  **错误处理**:
    *   对可能发生异常的代码块使用 `try-except` 进行捕获。
    *   提供明确的错误信息和适当的错误处理逻辑（如记录日志、重试、优雅失败等）。
3.  **遵循Pythonic风格**:
    *   遵循PEP 8编码规范。
    *   有效利用Python语言特性，编写简洁高效的代码。

**违反以上核心准则可能导致代码质量下降、维护成本增加，甚至引发严重的功能性或性能问题。如有任何疑问或特殊情况，请及时与项目架构师或团队负责人沟通。**
