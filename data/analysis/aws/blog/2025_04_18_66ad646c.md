
<!-- AI_TASK_START: AI标题翻译 -->
[新产品/新功能] 使用 VPC IPAM 简化 ALB 的公共 IP 地址分配

<!-- AI_TASK_END: AI标题翻译 -->


<!-- AI_TASK_START: AI竞争分析 -->
# 产品功能分析

## 新功能/新产品概述  
AWS 推出的 ALB 与 VPC IPAM 集成功能，核心在于简化互联网面向 **Application Load Balancer (ALB)** 的公共 IP 地址分配，允许使用可预测的 IP 地址块。该功能于 2025 年 3 月发布，针对 ALB 在 OSI 模型第 7 层处理 HTTP/HTTPS 请求的场景，提供更稳定的网络管理。**背景**：传统 ALB 使用随机 Amazon 拥有的公共 IP，难以维护 IP 允许列表；此集成解决这一问题，适用于需要 **Bring Your Own IP (BYOIP)** 的企业用户，如金融或电商行业。**目标用户群**：依赖 ALB 进行负载均衡的组织，特别是那些需与外部伙伴保持一致 IP 允许列表的场景。**市场定位**：在云计算市场中，该功能强化 AWS 的网络服务竞争力，聚焦于成本优化和可预测性，响应行业趋势向更精细的 IP 管理转型。

## 关键客户价值  
- **成本降低**：通过 BYOIP 地址减少 Amazon 提供的公共 IPv4 地址使用，潜在节省 _公共 IP 小时费用_，相比传统 IaaS 架构，该功能显著降低运维成本，但需注意 IPAM 池管理可能增加初始配置开销。  
- **IP 管理简化**：启用可预测 IP 地址，支持维护一致的 IP 允许列表，与外部伙伴或客户集成更便捷；差异化优势在于与其他云提供商（如 Azure 的 Load Balancer）相比，AWS 提供无缝 IPAM 集成，避免手动 IP 分配的复杂性，在高安全性场景中体现突出。  
- **可用性和灵活性提升**：ALB 支持双栈（IPv4 和 IPv6），适用于突发流量场景，量化收益包括 _IP 地址利用率优化_，实现机制通过 IPAM 池动态分配，确保高可用；然而，在 IP 地址不足时回退到 Amazon 池，可能导致 IP 列表不一致，需结合 CloudWatch 监控缓解。  
  - 子场景：在多可用区部署中，该功能提升架构灵活性，但大规模组网时管理复杂度上升，建议与传统方案比较时，强调其在 BYOIP 支持上的领先。

## 关键技术洞察  
- **技术独特性**：基于 **VPC IPAM** 池实现 IP 地址分配，工作原理是通过 API 调用从指定池中获取可预测 IP（如 192.0.2.144/29 CIDR），结合 **Amazon Route 53** 更新 ALB 的 FQDN，确保毫秒级 DNS 响应；创新点在于集成回退机制，当 IPAM 池不足时自动使用 Amazon 池，优化资源分配。  
- **对性能和安全的影响**：该功能提升 ALB 的可扩展性，通过 ENI 动态获取 IP，支持自动扩缩容，在高并发场景下提高 _资源利用率_，安全性上强化 IP 允许列表管理，减少外部攻击面；然而，挑战包括 IP 池耗尽风险，可能导致非确定性 IP 分配，解决方式是使用 CloudWatch 的 PercentAvailable 指标进行警报和扩容。  
- **技术实现的评估**：整体先进性高，适用于多可用区架构，但局限性在于仅支持互联网面向 ALB，且 BYOIPv6 未兼容；在行业趋势中，该集成推动事件驱动网络管理，但需关注冷启动时的 IP 分配延迟问题，相比竞品如 GCP 的 IPAM，该功能在 BYOIP 成本节约上更具优势。

## 其他信息  
- **注意事项**：该功能仅适用于互联网面向负载均衡器；多账户场景下，可通过 AWS RAM 共享 IPAM 池，但需升级到 IPAM 高级层以支持跨账户管理；总体而言，此功能有助于 AWS 在网络服务领域的长期竞争力，但用户应评估 IP 地址规划以避免潜在瓶颈。

<!-- AI_TASK_END: AI竞争分析 -->


<!-- AI_TASK_START: AI全文翻译 -->
# 使用 VPC IPAM 简化 ALB 的公网 IP 地址分配

**原始链接:** [https://aws.amazon.com/blogs/networking-and-content-delivery/simplify-albs-public-ip-address-assignment-with-vpc-ipam/](https://aws.amazon.com/blogs/networking-and-content-delivery/simplify-albs-public-ip-address-assignment-with-vpc-ipam/)

**发布时间:** 2025-04-18

**厂商:** AWS

**类型:** BLOG

---

[应用负载均衡器 (Application Load Balancer, ALB)](https://aws.amazon.com/elasticloadbalancing/application-load-balancer/) 在 OSI 模型的第 7 层运作，允许你对后端目标的 HTTP 和 HTTPS 请求进行负载均衡。在 2025 年 3 月，我们推出了 ALB 与 Amazon 虚拟私有云 IP 地址管理器 (VPC IPAM) 的集成，这允许你为面向互联网的 ALB 使用可预测的 IP 地址块。此功能有助于通过使用自带 IP (Bring Your Own IP, BYOIP) 地址来降低公网 IPv4 地址成本，并为面向互联网的 ALB 维护一致的 IP 允许列表（使用 BYOIPv4 或 Amazon 提供的连续前缀），以与外部合作伙伴或客户互动。

在本帖中，我们讨论了使用此功能的基础知识和注意事项，以及如何使用 [AWS 管理控制台 (AWS Management Console)](https://aws.amazon.com/console/) 和 API 进行设置。

## 先决条件

在以下部分中，我们假设你熟悉 ALB 的基础知识，例如配置 ALB、创建监听器以及关联目标组。你可以在 [文档](https://docs.aws.amazon.com/elasticloadbalancing/latest/application/introduction.html) 中找到更多关于 ALB 的信息，并查看 [弹性负载均衡器 (Elastic Load Balancer, ELB) 演示页面](https://exampleloadbalancer.com/)。

我们还假设你熟悉 AWS 网络服务，例如 Amazon [虚拟私有云 (Amazon VPCs)](https://docs.aws.amazon.com/vpc/latest/userguide/what-is-amazon-vpc.html)、子网、VPC 路由表和 [VPC IPAM](https://docs.aws.amazon.com/vpc/latest/ipam/what-it-is-ipam.html)。

## 为什么 ALB 需要确定性的 IP 地址？

面向互联网的 ALB 会从互联网上的客户端路由请求，并将这些请求转发到后端目标。面向互联网的 ALB 会为其弹性网络接口 (ENIs) 关联公网 IP 地址。在推出此功能之前，面向互联网的 ALB 会从 Amazon 拥有的区域公网 IP 地址块中随机获取公网 IP 地址。因此，客户无法为其面向互联网的 ALB 使用可预测的 IP 地址。

ALB 与 IPAM 的集成允许你为面向互联网的 ALB 使用可预测的公网 IP 地址，这有助于维护与外部合作伙伴或客户端的允许列表。此功能还支持 BYOIP 地址。Amazon 提供的公网 IP 地址会产生每小时费用，因此使用 BYOIP 地址块时，你可以节省公网 IP 使用成本。

使用此功能时，你的 ALB 可以是双栈，支持 IPv4 和 IPv6 地址。你可以使用 ALB 和 IPAM 集成来获取确定性的公网 IPv4 地址，而 IPv6 地址则来自 Amazon 拥有的区域 IPv6 地址块。这是因为在撰写时，BYOIPv6 地址不支持 ALB。

## 面向互联网 ALB 的 DNS

在本节中，我们讨论面向互联网 ALB 的 DNS 工作原理。我们将在后续部分讨论 ALB 与 IPAM 集成时以此为基础。

客户端使用 DNS 访问托管在面向互联网 ALB 后面的应用程序。每个面向互联网 ALB 都会获得一个完全限定域名 (FQDN)。AWS 会自动更新 FQDN 以包含 ALB 的公网 IP 地址，无论这些公网 IP 地址是由 Amazon 提供还是 BYOIP 地址。图 1 显示了 ALB 与 [Amazon Route 53](https://aws.amazon.com/route53/) 之间的交互。

![图 1: 面向互联网 ALB 的 DNS](https://d2908q01vomqb2.cloudfront.net/5b384ce32d8cdef02bc3a139d4cac0a22bb029e8/2025/04/14/alb-ipam-figure-1-new.png)

图 1: 面向互联网 ALB 的 DNS

## ALB 与 VPC IPAM 集成

你必须使用 VPC IPAM 为面向互联网的 ALB 提供可预测的 IP 地址。为此，首先需要创建一个区域 IPAM 池，其中包含 IP 地址块，然后配置 ALB 从 IPAM 池获取其公网 IP 地址。图 2 显示了面向互联网 ALB、VPC IPAM 和 DNS 之间的关系。

![图 2: ALB、VPC IPAM 和 DNS 之间的交互](https://d2908q01vomqb2.cloudfront.net/5b384ce32d8cdef02bc3a139d4cac0a22bb029e8/2025/04/14/alb-ipam-figure-2-new.png)

图 2: ALB、VPC IPAM 和 DNS 之间的交互

1. 创建 ALB API 调用引用 VPC IPAM 池以获取公网 IP 地址。在此示例中，ALB 在三个 [可用区 (Availability Zones, AZs)](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/Concepts.RegionsAndAvailabilityZones.html) 中创建。
2. ALB 尝试从 VPC IPAM 池为可用区 1 中的 ENI 获取公网 IP 地址。
3. VPC IPAM 池包含 192.0.2.144/29 CIDR，且池中有可用 IP 地址。IPAM 为可用区 1 中的 ALB ENI 分配下一个可用 IP 地址 (192.0.2.144)。
4. VPC IPAM 将此 IP 地址标记为“使用中”。
5. VPC IPAM 将分配的 IP 地址提供给 ALB。可用区 1 中的 ALB ENI 获取此 IP 地址。
6. Route 53 将分配的 IP 地址添加到 ALB 的 FQDN。

此过程会为 ALB 的每个 ENI 重复执行，每个 ENI 从 VPC IPAM 池获取一个公网 IP 地址。

如果你的 IPAM 池没有足够的可用 IP 地址来为 ALB 的所有 ENI 分配，ALB 会首先向 VPC IPAM 请求 IP 地址。VPC IPAM 会提供尽可能多的 IP 地址，其余 IP 地址则来自 Amazon 拥有的区域公网 IP 池。图 3 显示了此场景。

![图 3: 回退到 Amazon 拥有的区域公网 IP 池](https://d2908q01vomqb2.cloudfront.net/5b384ce32d8cdef02bc3a139d4cac0a22bb029e8/2025/04/14/alb-ipam-figure-3-new.png)

图 3: 回退到 Amazon 拥有的区域公网 IP 池

1. IPAM 池 (192.0.2.144/29) 总共有八个 IP 地址，其中六个在创建 ALB 之前已被使用。
2. 创建 ALB API 调用引用 VPC IPAM 池以获取公网 IP 地址。ALB 在三个可用区中创建。
3. VPC IPAM 池为可用区 1 和可用区 2 中的 ALB ENI 提供公网 IP 地址。此时，IPAM 池中的所有八个 IP 地址均已使用。
4. 可用区 3 中的 ALB ENI 从 VPC IPAM 请求公网 IP 地址。
5. VPC IPAM 池没有可用 IP 地址。
6. ，7. Amazon 拥有的区域公网 IP 地址池为可用区 3 中的 ALB ENI 提供下一个可用 IP 地址。

此回退机制确保了 ALB 的可用性，如果 VPC IPAM 池没有足够的 IP 地址。然而，这可能会使为面向互联网 ALB 提供确定性 IP 允许列表变得困难。为缓解此问题，我们建议使用 VPC IPAM 池的 [PercentAvailable CloudWatch 指标](https://docs.aws.amazon.com/vpc/latest/ipam/cloudwatch-ipam-ip-address-usage.html) 来警报可用 IP 地址百分比低于特定阈值。作为操作，你可以向 IPAM 池中添加更多 CIDR，并将新添加的 CIDR 提供给客户或合作伙伴用于允许列表场景。

## 此功能如何与 ALB 缩放配合？

ALB 由后台的一组 ALB 节点组成。在默认设置下，ALB 在每个可用区中配置一个节点，面向互联网的 ALB 需要为每个 ALB 节点分配一个私有 IP 和一个公网 IP 地址。ALB 可以根据流量和负载进行向上或向下缩放。当 ALB 缩放时，现有的节点可能被不同规格的 ALB 节点替换，或添加新的 ALB 节点。

如果面向互联网的 ALB 扩展并添加新节点，它会按照图 2 中概述的过程从 VPC IPAM 池获取公网 IP 地址。如果 VPC IPAM 池没有足够的 IP 地址，Amazon 拥有的区域公网 IP 池会为 ALB 扩展场景提供 IP 地址，如图 3 所示。

## 设置

本节展示如何为新 ALB 使用确定性 IP 地址。

### 步骤 1: 将 IP 前缀引入 VPC IPAM 池

第一步是在 VPC IPAM 池中配置 CIDR。你可以使用 Amazon 提供的公网 IP 地址或将 BYOIPv4 CIDR 引入 IPAM 池。参考文档了解在 VPC IPAM 中设置的详细信息。VPC IPAM 池的区域必须是您计划创建 ALB 的 AWS 区域。

验证 CIDR 在 IPAM 池中处于已配置状态。

![图 4: 验证 IPAM 池处于已配置状态](https://d2908q01vomqb2.cloudfront.net/5b384ce32d8cdef02bc3a139d4cac0a22bb029e8/2025/04/14/alb-ipam-figure-4.png)

图 4: 验证 IPAM 池处于已配置状态

### 步骤 2: 创建面向互联网 ALB 并配置它从 VPC IPAM 池获取 IP 地址

在创建面向互联网 ALB 时，选择 **使用 IPAM 池为公网 IPv4 地址** 选项。

![图 5: 在创建 ALB 时选择 IPAM 池](https://d2908q01vomqb2.cloudfront.net/5b384ce32d8cdef02bc3a139d4cac0a22bb029e8/2025/04/14/alb-ipam-figure-5.png)

图 5: 在创建 ALB 时选择 IPAM 池

或者，你可以使用以下 API 调用在创建面向互联网 ALB 时：

    aws elbv2 create-load-balancer \
    --type application \
    --name <ALB 名称> \
    --ip-address-type ipv4 \
    --subnets <子网列表，用空格分隔> \
    --scheme internet-facing \
    --ipam-pools  Ipv4IpamPoolId=<VPC IPAM 池 ID>

### 步骤 3: 验证

你可以在 ALB 的 **网络映射** 选项卡中查看提供公网 IPv4 地址的 IPAM 池详细信息，如下图所示。

![图 6: ALB 从 IPAM 池获取其公网 IP 地址](https://d2908q01vomqb2.cloudfront.net/5b384ce32d8cdef02bc3a139d4cac0a22bb029e8/2025/04/14/alb-ipam-figure-6.png)

图 6: ALB 从 IPAM 池获取其公网 IP 地址

## 将现有面向互联网 ALB 迁移到使用 VPC IPAM 提供的地址

在本节中，我们讨论了如果要为现有面向互联网 ALB 使用 VPC IPAM 池提供的公网 IPv4 地址的步骤和注意事项。

在现有 ALB 的网络映射选项卡中，选择 **编辑 IP 池**。

![图 7: 选择“编辑 IP 池”以将现有 ALB 迁移到使用 IPAM 提供的地址](https://d2908q01vomqb2.cloudfront.net/5b384ce32d8cdef02bc3a139d4cac0a22bb029e8/2025/04/14/alb-ipam-figure-7.png)

图 7: 选择“编辑 IP 池”以将现有 ALB 迁移到使用 IPAM 提供的地址

在下一个屏幕中，选择 **使用 IPAM 池为公网 IPv4 地址**，然后从下拉列表中选择 IPAM 池：

![图 8: 为 ALB 的公网 IP 地址选择 IPAM 池](https://d2908q01vomqb2.cloudfront.net/5b384ce32d8cdef02bc3a139d4cac0a22bb029e8/2025/04/14/alb-ipam-figure-8.png)

图 8: 为 ALB 的公网 IP 地址选择 IPAM 池

你也可以使用以下 API 调用为现有面向互联网 ALB 使用 VPC IPAM 池提供的公网 IPv4 地址：

    aws elbv2 modify-ip-pools \
    --load-balancer-arn <ALB 的 ARN> \
    --ipam-pools Ipv4IpamPoolId=<VPC IPAM 池 ID>

当你为现有面向互联网 ALB 更改 IP 池时，ALB 会创建新的 ENI，并为新接口使用 VPC IPAM 池提供的 IPv4 地址。新 ENI 还会从私有子网的 CIDR 中消耗每个一个 IP 地址。因此，我们建议你监控私有子网的 IP 地址使用情况，并确保有足够的私有 IP 地址来支持 ALB 创建的新 ENI。你可以使用 VPC IPAM 的 SubnetIPUsage CloudWatch 指标来监控子网的 IP 地址使用情况。参考 [VPC IPAM CloudWatch 指标页面](https://docs.aws.amazon.com/vpc/latest/ipam/cloudwatch-ipam-res-util.html) 了解更多详细信息。

在将现有面向互联网 ALB 迁移到使用 VPC IPAM 池为公网 IP 地址后，ALB 的 FQDN 仅解析为 IPAM 池提供的 IP 地址。然而，ALB 会保持任何现有连接打开，直到 ALB 配置的 HTTP keepalive 持续时间。参考 [此 Amazon 网络帖子](https://aws.amazon.com/blogs/networking-and-content-delivery/introducing-dual-stack-without-public-ipv4-application-load-balancer/) 了解如何使用 HTTP keepalive 计时器优雅地终止客户端连接的详细信息。

当 ALB 的非 VPC IPAM 池提供的公网 IP 地址上的所有打开连接关闭后，ALB 会删除与先前公网 IPv4 地址集相关的 ENI。此时，你只会看到 ALB 新 IP 地址的 ENI。此机制确保 ALB 最佳使用你的子网的私有 IP 地址。

与先前 IP 地址相关的 ENI 被删除，因此任何可能已缓存 ALB 先前公网 IPv4 地址的 DNS 响应的客户端不会收到响应。为缓解此问题，我们建议优化 DNS 记录的 TTL 设置，或让客户端在迁移 ALB 后刷新其 DNS 缓存。

## 注意事项

- ALB 的确定性 IP 地址功能仅适用于面向互联网的负载均衡器。
- 在为 ALB 的 ENI 使用 IPAM 池中的 IP 地址创建 ALB 后，你无法删除任何正在使用的 CIDR。
- 在多账户场景中，你可以使用 VPC IPAM 将 CIDR 引入中央账户，然后使用 AWS [资源访问管理器 (AWS RAM)](https://aws.amazon.com/ram/) 在多个账户之间共享 VPC IPAM 池。查看 VPC IPAM [文档](https://docs.aws.amazon.com/vpc/latest/ipam/share-pool-ipam.html) 了解更多详细信息。
- 你需要 VPC IPAM 高级层来管理多个账户中的 IP 寻址。阅读 [VPC IPAM 定价页面](https://aws.amazon.com/vpc/pricing/) 了解高级层包含的功能和成本信息。

## 结论

在本帖中，我们解释了 ALB 与 Amazon VPC IPAM 的集成，以及如何使用控制台和 API 利用此功能。此集成允许你通过使用 BYOIPv4 地址与 ALB 减少 Amazon 提供的公网 IPv4 成本。此新功能还允许你在面向互联网的 ALB 上获取连续的公网 IPv4 地址，这使得维护与外部合作伙伴或客户的面向互联网 ALB 的一致 IP 允许列表变得更容易。

要开始使用，请阅读 [ALB 文档](https://docs.aws.amazon.com/elasticloadbalancing/latest/application/application-load-balancers.html#ip-pools)。

## 作者简介

![Pushkar 照片](https://d2908q01vomqb2.cloudfront.net/5b384ce32d8cdef02bc3a139d4cac0a22bb029e8/2025/04/14/alb-ipam-epushkar-photo.jpg)

### Pushkar Patil

Pushkar Patil 是位于加利福尼亚的 AWS 网络团队的产品负责人。他拥有超过十年的经验，在云计算和基础设施领域推动产品创新和战略规划。Pushkar 通过理解客户需求并提供创新解决方案，成功推出了许多新产品。在不工作时，你可以发现这位板球爱好者与家人旅行。

![Ankit Chadha 照片](https://d2908q01vomqb2.cloudfront.net/5b384ce32d8cdef02bc3a139d4cac0a22bb029e8/2024/01/26/aichadha-blogs-headshot.png)

### Ankit Chadha

Ankit 是 AWS 支持 AWS 行业账户的网络专家解决方案架构师。他喜欢为客户构建安全且可扩展的网络架构。在业余时间，Ankit 喜欢打板球、赢得猫的信任以及阅读传记。

<!-- AI_TASK_END: AI全文翻译 -->

