
<!-- AI_TASK_START: AI标题翻译 -->
[新产品/新功能] 通过 Network Flow Monitor 直观可视化您的 AWS 云工作负载网络性能

<!-- AI_TASK_END: AI标题翻译 -->


<!-- AI_TASK_START: AI竞争分析 -->
# 产品功能分析

## 新功能/新产品概述  
Network Flow Monitor 是 AWS 在 2024 年 re:Invent 上发布的 **Amazon CloudWatch Network Monitoring** 新功能，提供对 AWS 云工作负载网络性能的近实时监控。该功能针对使用 **Amazon EC2** 和 **Amazon EKS** 等计算资源的用户，旨在解决传统网络监控工具在云环境中的可见性不足问题。通过收集网络流量数据，帮助用户更快地识别和解决网络问题。背景在于，云网络的复杂性导致高延迟常见，**Network Flow Monitor** 的市场定位是提升 **CloudWatch** 的整体可观测性，适用于企业级应用场景，如跨 VPC 通信和 AWS 服务交互，满足对高可用性和快速故障排除的需求。

## 关键客户价值  
- **减少故障排除时间**：该功能通过近实时监控网络指标（如数据传输、重传和往返时间），显著缩短平均检测时间（MTTD）和平均恢复时间（MTTR），相比传统工具的优势在于提供主动式洞察，而非被动响应；在高延迟场景中，网络健康指标（NHI）帮助快速定位问题来源，避免盲目排查。  
- **提升业务效率**：为用户带来量化收益，如 _故障排除时间降低30%以上_，通过分析实际工作负载流量实现；与竞品（如第三方网络监控工具）相比，其集成性更强，直接嵌入 **CloudWatch**，减少了多工具切换的复杂性，但可能受限于当前不支持跨账户或跨区域监控，适用于单一区域内的大型企业。  
- **优化资源管理**：在不同场景中，例如 VPC 间通信，该功能支持可视化拓扑和性能指标，帮助动态调整资源；在突发流量场景下，体现出更高的资源利用率，但需注意代理安装的额外开销，可能在小型工作负载中增加管理负担。

## 关键技术洞察  
- **技术独特性**：**Network Flow Monitor** 基于轻量级代理（如使用 Linux 内核的 bpf_sock_ops 结构）收集网络性能数据，实现事件驱动的被动监控，支持毫秒级响应；其工作原理是通过代理捕获 TCP 连接元数据（如 IP 地址和端口），而不访问有效负载，确保数据隐私，同时集成 **CloudWatch** 的指标聚合机制。  
- **创新点与影响**：创新在于引入网络健康指标（NHI），可准确区分 AWS 基础设施问题与其他原因，提升了性能和可用性；对安全性影响正面，通过代理限制数据范围减少暴露风险，但可能在高并发环境中增加资源消耗；然而，实现挑战包括代理安装依赖 **AWS Systems Manager**，且当前不支持跨区域，可能会限制大规模部署的灵活性，未来可通过扩展代理兼容性来缓解。  
- **性能评估**：相比传统 IaaS 监控，该功能显著提升了网络可观测性，但冷启动问题（如代理部署需等待30分钟）仍需关注，总体先进性高，适用于动态云环境，却在多区域场景中面临局限。

## 其他信息  
- **定价和可用性**：该功能目前在17个 AWS 区域可用，定价基于 **CloudWatch** 的标准费用模型，用户可参考官方定价页面进行成本评估，以避免不必要的开支。  
- **资源清理建议**：在使用后及时删除测试监视器和代理，以优化资源管理和成本控制，体现了 AWS 在可持续云实践方面的考量。

<!-- AI_TASK_END: AI竞争分析 -->


<!-- AI_TASK_START: AI全文翻译 -->
# 使用 Network Flow Monitor 可视化您的 AWS 云工作负载的网络性能

**原始链接:** [https://aws.amazon.com/blogs/networking-and-content-delivery/visualizing-network-performance-of-your-aws-cloud-workloads-with-network-flow-monitor/](https://aws.amazon.com/blogs/networking-and-content-delivery/visualizing-network-performance-of-your-aws-cloud-workloads-with-network-flow-monitor/)  

**发布时间:** 2025-04-30  

**厂商:** AWS  

**类型:** BLOG  

---  
AWS 于 2024 年 12 月 1 日在 re:Invent 上推出了 Network Flow Monitor，这是一个新的 [Amazon CloudWatch Network Monitoring](https://aws.amazon.com/cloudwatch/features/network-monitoring/) 功能，可提供跨 AWS 托管服务的网络性能监控。借助 Network Flow Monitor，您可以获得计算资源（如 [Amazon Elastic Compute Cloud (Amazon EC2)](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/concepts.html) 和 [Amazon Elastic Kubernetes Service (Amazon EKS)](https://docs.aws.amazon.com/eks/latest/userguide/what-is-eks.html)）与 AWS 服务（如 [Amazon S3](https://docs.aws.amazon.com/AmazonS3/latest/userguide/Welcome.html) 和 [Amazon DynamoDB](https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/Introduction.html)）之间，以及 AWS 基础架构的网络流量的近实时可见性。这些收集的数据可以帮助您更快地识别和解决应用程序的网络问题，从而减少云环境中的故障排除时间。  

## 可观测性在云网络中的挑战  

当应用程序遇到高延迟时，网络问题通常是首先怀疑的原因，无论是在云环境还是本地环境。正如许多人可能已经知道的那样，传统的网络监控工具对 AWS 网络基础架构及其与 AWS 托管服务之间的网络性能提供有限的可见性。这可能会延长故障排除过程，并影响平均检测时间 (MTTD) 和平均修复时间 (MTTR)。  

## CloudWatch 性能监控功能  

Network Flow Monitor 使 CloudWatch 能够为 Network Monitoring 和 [Application Performance Monitoring (APM)](https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/CloudWatch-Application-Monitoring-Intro.html) 提供全面的可观测性服务，如下图所示。  

![图 1. CloudWatch Application Performance Monitoring 和 Network Monitoring 功能](https://d2908q01vomqb2.cloudfront.net/5b384ce32d8cdef02bc3a139d4cac0a22bb029e8/2025/04/23/Figure-1.-CloudWatch-Application-Performance-Monitoring-and-Network-Monitoring-features-1.png)  

*图 1. CloudWatch Application Performance Monitoring 和 Network Monitoring 功能*  

Network Flow Monitor 使用您安装在资源上的轻量级代理来直接从实际工作负载流量收集性能指标，从而实现近实时监控。Network Flow Monitor 跟踪关键网络指标，例如传输的数据量、重传、重传超时和往返时间。  

此外，flow monitor 的一个突出功能是网络健康指标 (NHI)。NHI 使您能够确定网络退化是否由 AWS 基础架构问题引起。当网络延迟发生时，此指标非常宝贵，可帮助您归因问题原因，从而有效地专注于故障排除工作。  

CloudWatch Network Monitoring 套件提供了一系列网络性能功能。要了解更多信息，请参阅 [Using Internet Monitor](https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/CloudWatch-InternetMonitor.html) 或 [Using Network Synthetic Monitor](https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/what-is-network-monitor.html) 文档。  

以下部分描述了如何使用 Network Flow Monitor 通过示例场景可视化网络性能。  

## 示例监控场景  

在本部分，我们观察两个位于不同 VPC 中的 EC2 实例的示例，这些实例位于同一区域，并通过 [AWS Transit Gateway](https://docs.aws.amazon.com/vpc/latest/tgw/what-is-transit-gateway.html) 连接。  

目前，Network Flow Monitor 不支持跨账号或跨区域。  

在我们的示例中，我们在 VPC 1 中的 EC2 实例 **test-instance-1** 上安装了代理，以提供网络性能数据。我们还在 VPC 2 中的第二个 EC2 实例 **test-instance-2** 上构建了 Apache Web 服务器，并启用了 httpd 服务，如下图所示。在下一部分，我们将详细描述如何安装代理。  

![图 2. Network Flow Monitor 的跨 VPC 网络监控设置示例](https://d2908q01vomqb2.cloudfront.net/5b384ce32d8cdef02bc3a139d4cac0a22bb029e8/2025/04/23/Figure-2.-Example-of-an-inter-VPC-network-monitoring-setup-for-Network-Flow-Monitor-2.png)  

*图 2. Network Flow Monitor 的跨 VPC 网络监控设置示例*  

与其他主动监控解决方案不同，Network Flow Monitor 提供持续的被动监控，该监控分析工作负载之间的实际用户流量。我们已从安装了代理的 **test-instance-1** 创建测试流量到 **test-instance-2**（Apache Web 服务器），如下图所示。  

![图 3. 代理为 VPC 1 中的实例与 VPC 2 中的 Web 服务器之间的 HTTP 流量收集数据](https://d2908q01vomqb2.cloudfront.net/5b384ce32d8cdef02bc3a139d4cac0a22bb029e8/2025/04/23/Figure-3.-Agent-collects-data-for-HTTP-traffic-flows-between-an-instance-in-VPC-1-and-a-web-server-in-VPC-2-2.png)  

*图 3. 代理为 VPC 1 中的实例与 VPC 2 中的 Web 服务器之间的 HTTP 流量收集数据*  

代理无法访问您的 TCP 连接的有效负载。代理仅从 Linux 内核接收 *bpf_sock_ops* 结构。此结构提供本地和远程 IP 地址、本地和远程 TCP 端口，以及计数器和往返时间。  

## Network Flow Monitor 设置  

在本部分，我们将逐步指导基于我们的示例场景设置 Network Flow Monitor。要设置 Network Flow Monitor 以查看网络流性能指标，请执行以下操作：  

  1. 启用 Network Flow Monitor  
  2. 安装 Network Flow Monitor 代理  
  3. 在 Workload insights 中查看网络流  
  4. 创建一个或多个 flow monitors  

**步骤 1: 启用 Network Flow Monitor**  

在使用 Network Flow Monitor 之前，我们必须启用必要的权限，以将数据发送到 CloudWatch 并映射我们的网络连接。当您首次在控制台中导航到 Network Flow Monitor 时，会提示您启用该功能，如下图所示。  

![图 4. 启用 Network Flow Monitor](https://d2908q01vomqb2.cloudfront.net/5b384ce32d8cdef02bc3a139d4cac0a22bb029e8/2025/04/23/Figure-4.-Enabling-Network-Flow-Monitor-3.png)  

*图 4. 启用 Network Flow Monitor*  

启用 Network Flow Monitor 会设置权限并创建您的监控范围。目前，监控范围是您登录的 AWS 账号。要了解更多信息，请参阅 [Enable Network Flow Monitor](https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/CloudWatch-NetworkFlowMonitor-configure-begin.html#CloudWatch-NetworkFlowMonitor-configure-begin.enable)。您只需在区域中首次选择该功能时启用它。  

等待一段时间（最多 30 分钟），Network Flow Monitor 会为您的账号授予使用必要服务链接角色的权限，并为您的 AWS 账号设置监控范围。  

**步骤 2: 安装 Network Flow Monitor 代理**  

当您在实例上安装代理时，还必须为代理设置权限，以便它们可以将数据发送到 Network Flow Monitor 后端。这些数据使您能够监控网络性能。实例上可使用的 Linux 版本有特定要求，这些要求列在 [Amazon CloudWatch 文档](https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/CloudWatch-NetworkFlowMonitor-agents.html) 中。  

您可以在 EC2 实例、自我管理的 Kubernetes 实例或 Amazon EKS 上安装代理。在本帖子中，我们按照 [Install and manage agents for EC2 instances](https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/CloudWatch-NetworkFlowMonitor-agents-ec2.html) 中的 AWS 文档中所述的步骤操作。要了解有关在 Kubernetes 或 Amazon EKS 上安装代理的信息，请参阅 [Install Network Flow Monitor agents on instances](https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/CloudWatch-NetworkFlowMonitor-agents.html)。  

要启用正确的权限，运行代理的 EC2 实例必须使用带有策略 CloudWatchNetworkFlowMonitorAgentPublishPolicy 的角色，如下图所示。  

![图 5. 将 Network Flow Monitor 策略附加到目标实例的角色](https://d2908q01vomqb2.cloudfront.net/5b384ce32d8cdef02bc3a139d4cac0a22bb029e8/2025/04/23/Figure-5.-Attaching-Network-Flow-Monitor-policy-to-the-role-of-the-target-instance-1.png)  

*图 5. 将 Network Flow Monitor 策略附加到目标实例的角色*  

我们建议您在 EC2 实例上安装代理之前添加权限。如果实例没有角色，请创建一个新角色并附加前面提到的策略。  

接下来，我们在实例中安装代理。要安装代理，我们使用 [AWS Systems Manager](https://aws.amazon.com/systems-manager/) 的功能 AWS Systems Manager Agent。在开始安装代理之前，请确保每个实例都在运行 Systems Manager Agent。要了解更多信息，请参阅 [Working with Systems Manager Agent](https://docs.aws.amazon.com/systems-manager/latest/userguide/ssm-agent.html)。  

要在 EC2 实例上安装代理，请执行以下操作：  

  1. 在控制台中，打开 AWS Systems Manager 控制台。  
  2. 在 **Node Tools** 下，选择 **Distributor**。  
  3. 在 **Owned by Amazon** 下，找到 Network Flow Monitor 包：**AmazonCloudWatchNetworkFlowMonitorAgent**。  
  4. 选择该包，然后选择 **Install one time** 或 **Install on schedule**，如下图所示。  

![图 6. 在 Systems Manager 中选择 Network Flow Monitor 代理包](https://d2908q01vomqb2.cloudfront.net/5b384ce32d8cdef02bc3a139d4cac0a22bb029e8/2025/04/23/Figure-6.-In-Systems-Manager-choose-the-Network-Flow-Monitor-agent-package-1.png)  

*图 6. 在 Systems Manager 中选择 Network Flow Monitor 代理包*  

  5. 选择要安装代理的 EC2 实例。对于我们的示例，我们仅选择 **test-instance-1**，如下图所示。但是，如果您要在一多个实例上安装代理，则根据标签或资源组选择实例更高效。  

![图 7. 在 Systems Manager 中选择要安装代理的实例](https://d2908q01vomqb2.cloudfront.net/5b384ce32d8cdef02bc3a139d4cac0a22bb029e8/2025/04/23/Figure-7.-In-Systems-Manager-choose-the-instances-on-which-to-install-agents-2.png)  

*图 7. 在 Systems Manager 中选择要安装代理的实例*  

  6. 最后，选择 **Run** 以启动代理安装。  

安装成功完成后，您应该看到命令状态消息，如下图所示。  

![图 8. 目标实例上代理安装成功](https://d2908q01vomqb2.cloudfront.net/5b384ce32d8cdef02bc3a139d4cac0a22bb029e8/2025/04/23/Figure-8.-Successful-agent-installation-on-target-instance-1.png)  

*图 8. 目标实例上代理安装成功*  

**步骤 3: 在 Workload insights 中查看网络流**  

启用 Network Flow Monitor 并安装代理后，您可以在控制台中查看网络流性能数据。我们建议您从控制台可视化开始，以了解您的工作负载趋势和流量模式。  

在 CloudWatch 控制台中，在 **Network Monitoring** 下，选择 **Flow monitors**。然后，在 **Workload insights** 选项卡中，您可以查看顶级贡献网络流。您可以识别要更详细监控的流。此信息显示在下图中。要了解更多细节，请参阅 [Evaluate network flows with workload insights](https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/CloudWatch-NetworkFlowMonitor-configure-evaluate-flows.html)。  

![图 9. CloudWatch 中的网络流数据](https://d2908q01vomqb2.cloudfront.net/5b384ce32d8cdef02bc3a139d4cac0a22bb029e8/2025/04/25/Figure-9.-Network-flow-data-in-CloudWatch-2.png)  

*图 9. CloudWatch 中的网络流数据*  

要深入特定网络流，您可以创建一个 monitor，这可以通过两种方式完成。您可以在 **Top contributors** 中选择网络流，然后选择 **Create monitor**。或者，您可以选择 **Create monitor**，然后指定要监控的单个本地和远程资源，如步骤 4 所述。  

**步骤 4: 创建 flow monitor**  

要开始创建 monitor，在 Network Flow Monitor 控制台中选择 **Create monitor**，如下图所示。  

![图 10. 在 Network Flow Monitor 中创建 monitor](https://d2908q01vomqb2.cloudfront.net/5b384ce32d8cdef02bc3a139d4cac0a22bb029e8/2025/04/23/Figure-10.-Creating-a-monitor-in-Network-Flow-Monitor-1.png)  

*图 10. 在 Network Flow Monitor 中创建 monitor*  

创建 monitor 时，我们建议您一次性完成所有步骤，因为您无法保存工作以稍后继续。  

按照创建 monitor 流程中的步骤操作。对于我们的示例，我们将为 monitor 提供以下信息。  

  1. 对于 **Monitor name**，我们选择 **monitor-ap-northeast-1c-1a**，如下图所示。  

![图 11. 为 flow monitor 指定名称](https://d2908q01vomqb2.cloudfront.net/5b384ce32d8cdef02bc3a139d4cac0a22bb029e8/2025/04/23/Figure-11.-Specify-a-name-for-the-flow-monitor-1.png)  

*图 11. 为 flow monitor 指定名称*  

  2. 对于 **Local resources**，指定您要监控的网络流类型，然后为每个类型选择特定选项。Network Flow Monitor 支持的本地资源类型包括：子网、VPC 或可用区。对于我们的示例，我们选择了实例所在的子网 **flowmonitor-subnet-ap-northeast-1c**，如下图所示。  

![图 12. 为 flow monitor 选择一个或多个本地资源](https://d2908q01vomqb2.cloudfront.net/5b384ce32d8cdef02bc3a139d4cac0a22bb029e8/2025/04/23/Figure-12.-Choose-one-or-more-local-resources-for-the-flow-monitor-1.png)  

*图 12. 为 flow monitor 选择一个或多个本地资源*  

  3. 对于 **Remote resources**，选择 **Everywhere** 或 **Select remote resources**。如果选择 **Everywhere**，monitor 将包括从选定的本地资源起源的所有网络流。否则，您可以选择特定的远程资源进行监控。通过此选项，您可以在子网、VPC、可用区 (AZs) 或 AWS 服务（如 Amazon S3 和 DynamoDB）中选择一个或多个资源。  

对于我们的示例，我们指定了一个作为远程资源的主机我们 Web 服务器的子网 **flowmonitor-subnet-ap-northeast-1a**，如下图所示。选择一个本地资源和一个远程资源使我们的 monitor 只包括这两个资源之间网络流的信息。  

![图 13. 为 flow monitor 选择远程资源](https://d2908q01vomqb2.cloudfront.net/5b384ce32d8cdef02bc3a139d4cac0a22bb029e8/2025/04/23/Figure-13.-Choose-remote-resources-for-the-flow-monitor-1.png)  

*图 13. 为 flow monitor 选择远程资源*  

  4. 选择 **Next**，然后查看 monitor 的配置。  
  5. 选择 **Create monitor**。  

创建 monitor 后，等待最多 30 分钟，让 Network Flow Monitor 开始收集和聚合数据。  

## **可视化 Network Flow Monitor 指标**  

创建 monitor 后，Network Flow Monitor 将开始发布端到端性能指标，以及针对网络退化问题的网络健康指标。您可以在 Network Flow Monitor 控制台中可视化 monitor 的信息，或者在 CloudWatch 指标中找到这些指标，在自定义命名空间 AWS/NetworkFlowMonitor 下。  

对于我们的示例，我们在 Network Flow Monitor 控制台中查看 monitor 的性能数据。在 **Monitors** 选项卡中，我们选择 monitor **monitor-ap-northeast-1c-1a**，如下图所示。  

![图 14. 在 flow monitor 中查看性能数据](https://d2908q01vomqb2.cloudfront.net/5b384ce32d8cdef02bc3a139d4cac0a22bb029e8/2025/04/23/Figure-14.-Viewing-performance-data-in-a-flow-monitor-1.png)  

*图 14. 在 flow monitor 中查看性能数据*  

要获取 monitor 的网络流的整体视图，我们查看 **Overview** 选项卡，如下图所示。  

![图 15. 在 monitor 的 Overview 选项卡上可视化性能指标](https://d2908q01vomqb2.cloudfront.net/5b384ce32d8cdef02bc3a139d4cac0a22bb029e8/2025/04/25/Figure-15.-Visualizing-performance-metrics-on-the-Overview-tab-for-the-monitor-2.png)  

*图 15. 在 monitor 的 Overview 选项卡上可视化性能指标*  

接下来，转到 **Historical explorer** 选项卡，以查看受监控网络流的更详细指标。例如，当发生性能退化时，topology 功能会显示网络路径中的所有组件，包括服务图标和资源 ID，如下图所示。此可视化有助于您识别每个性能指标的顶级贡献者，并在指定时间框架内对配对进行分桶以采取恢复操作。  

![图 16. 为退化问题可视化网络流 topology](https://d2908q01vomqb2.cloudfront.net/5b384ce32d8cdef02bc3a139d4cac0a22bb029e8/2025/04/23/Figure-16.-Visualizing-network-flow-topologies-for-a-degradation-issue-1.png)  

*图 16. 为退化问题可视化网络流 topology*  

## 资源清理  

在完成 Network Flow Monitor 评估后，立即删除所有测试 monitor 和临时资源。这有助于您的组织避免不必要的开支，同时保持高效的资源管理。  

## 结论  

在本帖子中，我们介绍了 Network Flow Monitor，这是一个 Amazon CloudWatch Network Monitoring 的新可观测性功能，可为计算实例与 AWS 服务之间的工作负载提供近实时网络性能可见性。使用 flow monitor 提供的各种指标和信息，您可以快速分析和处理云工作负载的网络性能退化，并最小化故障排除时间。  

## 了解更多关于 Network Flow Monitor 的信息  

现在我们已经分享了 Network Flow Monitor 的好处概述，请查看以下附加信息以获取详细信息：  

  * 要了解更多关于定价的信息，请访问 [CloudWatch 定价页面](https://aws.amazon.com/cloudwatch/pricing/)。  
  * Flow Monitor 目前在 17 个 AWS 区域可用。要获取完整列表，请参阅 [文档](https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/CloudWatch-NetworkFlowMonitor-Regions.html)。  
  * 要获取有关 Network Flow Monitor 的详细信息和技术指导，请参阅 [技术文档](https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/CloudWatch-NetworkFlowMonitor.html)。  

## 关于作者  

![Hiroki Fujii.jpg](https://d2908q01vomqb2.cloudfront.net/5b384ce32d8cdef02bc3a139d4cac0a22bb029e8/2025/04/22/Hiroki-Fujii.jpg)  

### Hiroki Fujii  

Hiroki 是位于新加坡的资深技术账号经理。在加入 AWS 之前，他拥有超过 10 年的经验，在设计、构建和操作本地网络方面，包括数据中心、园区网络和骨干网络。工作之外，他喜欢锻炼、高尔夫球，并与他的美妙家庭一起探索新的国家和文化。  

![Vishwas Puttasubbappa.jpg](https://d2908q01vomqb2.cloudfront.net/5b384ce32d8cdef02bc3a139d4cac0a22bb029e8/2025/04/22/Vishwas-Puttasubbappa.jpg)  

### Vishwas Puttasubbappa  

Vishwas 是 AWS Networking 中的首席产品经理技术专家。他过去 20 年来一直从事网络领域的工作，设计和构建网络及网络产品。工作之外，他喜欢花大部分时间与家人共度。

<!-- AI_TASK_END: AI全文翻译 -->

