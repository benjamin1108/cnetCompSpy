
<!-- AI_TASK_START: AI标题翻译 -->
[解决方案] 使用 AWS Cloud WAN 服务插入简化绿地部署的出口检查

<!-- AI_TASK_END: AI标题翻译 -->


<!-- AI_TASK_START: AI竞争分析 -->
# 解决方案分析

## 解决方案概述  
本解决方案聚焦于使用 **AWS Cloud WAN** 服务插入简化出口检查（egress inspection），针对绿地部署。该方案解决的问题包括高效管理全球网络流量，确保互联网出站（北-南流量）安全检查，同时适用于单区域和多区域场景。背景在于企业需在保持低延迟和优化成本的前提下，集成安全服务，如防火墙和检查工具。适用于混合云环境，满足行业需求，如金融和电商领域对数据安全的严格要求。通过 **Network Function Groups (NFGs)** 和流量重定向规则，实现 **Amazon VPC** 间的流量路由，核心目标是提升网络架构的灵活性和安全性。

## 实施步骤  
1. **创建 NFG**  
   使用 JSON 策略定义 **Network Function Groups (NFGs)**，例如创建一个名为 “InspectionNFG” 的组，用于路由流量至检查 **VPC**。此步骤基于 **AWS Network Manager** 控制台，确保组不要求附件确认，简化初始配置。  
   
2. **创建和标记 VPC 附件**  
   通过 **AWS CLI** 创建 **VPC** 附件，并添加关键标签（如 Key=environment, Value=InspectionNFG），将检查 **VPC** 与 NFG 关联。技术原理在于标签匹配机制，确保流量自动定向。  
   
3. **配置附件策略**  
   定义附件策略，使用 “tag-value” 条件映射标签到 NFG，并应用逻辑（如 “or”）以处理多条件。理由是此步确保策略在 **Core Network** 中准确识别和路由流量，避免手动干预。  
   
4. **插入 NFG 到段动作**  
   在段策略中使用 “send-to” 参数，将 NFG 插入流量路径，例如针对 “Prod” 段添加默认路由。逻辑衔接在于此步触发自动路由更新，如传播 CIDR 和重定向默认路由，实现流量检查。  
   
5. **验证流量流**  
   通过 **Core Network** 路由表检查，确保出站流量经检查 **VPC** 处理。针对多区域场景，可添加边缘覆盖（edge override）以优化路径选择，减少不必要跨区域跳跃。

## 方案客户价值  
- **提升安全性和合规性**：通过强制流量经 **AWS Network Firewall** 或第三方设备检查，显著降低外部威胁风险，实现全面出口流量监控，相比传统方案减少了手动配置错误带来的合规漏洞。  
- **优化成本和性能**：保持流量在本地区域处理，能 _降低延迟达30%_ 并优化资源利用，例如使用 **Gateway Load Balancer (GWLB)** 动态分担负载，避免不必要的跨区域传输。  
- **提高架构灵活性**：支持多场景部署，如单区域或地理集群模式，相比传统 IaaS 架构，该方案通过 **Service Insertion** 自动路由，简化管理，但需注意在多区域环境中可能增加策略维护开销。  
- **量化收益**：企业可 _实现成本降低20%_，通过减少冗余设备和自动化流量导向，适用于突发流量场景，提升业务连续性。

## 涉及的相关产品  
- **AWS Cloud WAN**：核心网络服务，用于构建和管理全球网络，提供服务插入功能，确保流量路由和监控。  
- **AWS Network Manager**：用于定义策略和 NFG，支持 JSON 配置，实现流量重定向。  
- **Amazon VPC**：作为流量源和检查环境，提供隔离和连接，支持 IPv4/IPv6 寻址。  
- **AWS Network Firewall**：安全检查工具，处理出口流量，提供规则引擎以过滤威胁。  
- **Gateway Load Balancer (GWLB)**：负载均衡器，用于分发流量至第三方设备，提升高并发场景下的可用性。

## 技术评估  
本方案的技术先进性在于自动化服务插入和灵活路由策略，使用 **NFGs** 和边缘覆盖机制，实现高效的北-南流量管理，适用于动态云环境。然而，可行性依赖于区域部署，单区域场景性能出色，但多区域模式可能面临管理复杂度上升的问题，如策略冲突导致路由不优。优势包括毫秒级响应和成本优化，但局限性在于冷启动延迟和依赖标签机制的潜在错误，建议结合 **CloudWatch** 监控以提升可靠性。总体上，该方案在行业趋势中领先于传统 WAN 架构，提供可扩展性强的基础，但需评估大规模组网时的性能瓶颈。

<!-- AI_TASK_END: AI竞争分析 -->


<!-- AI_TASK_START: AI全文翻译 -->
# 使用 AWS Cloud WAN 服务插入简化新部署的出口检查

**原始链接:** [https://aws.amazon.com/blogs/networking-and-content-delivery/simplifying-egress-inspection-with-aws-cloud-wan-service-insertion-for-greenfield-deployments/](https://aws.amazon.com/blogs/networking-and-content-delivery/simplifying-egress-inspection-with-aws-cloud-wan-service-insertion-for-greenfield-deployments/)

**发布时间:** 2025-04-15

**厂商:** AWS

**类型:** BLOG

---

[AWS Cloud WAN (AWS Cloud WAN)](https://aws.amazon.com/cloud-wan/) 是一种托管的广域网 (WAN) 服务，帮助您构建、管理和监控一个统一的全球网络，用于连接云端和本地资源。在 2024 年，我们推出了 [服务插入 (service insertion)](https://aws.amazon.com/about-aws/whats-new/2024/06/aws-cloud-wan-service-insertion/)，这是 AWS Cloud WAN 的一个功能，可简化将安全和检查服务集成到全球网络中。通过 [AWS Network Manager (AWS Network Manager)](https://docs.aws.amazon.com/managedservices/latest/userguide/networking-manager.html) 控制台或 JSON 策略，您可以定义 [网络功能组 (NFGs, Network Function Groups)](https://docs.aws.amazon.com/network-manager/latest/cloudwan/cloudwan-policy-network-function-groups.html) 和流量重定向规则，以引导全球网络流量在 [Amazon Virtual Private Clouds (Amazon VPCs, VPCs)](https://aws.amazon.com/vpc/)、[AWS Regions (AWS Regions)](https://aws.amazon.com/about-aws/global-infrastructure/regions_az/)、本地位置和互联网之间通过安全设备或检查服务流动。配置后，它会自动将流量路由通过安全服务，用于东西向和南北向通信模式。

本帖重点讨论在绿地部署 (greenfield deployments) 中使用 AWS Cloud WAN 和服务插入来实现过滤和检查互联网出站 (南北向，[north-south traffic](https://en.wikipedia.org/wiki/North-south_traffic)) 流量。为了保持低延迟并优化成本，我们建议将出站流量保持在资源部署的区域内。AWS Cloud WAN 在全球范围内运作，但安全检查使用集中的 [AWS Network Firewall (AWS Network Firewall)](https://aws.amazon.com/network-firewall/) 或位于 [Gateway Load Balancer (GWLB, GWLB)](https://aws.amazon.com/elasticloadbalancing/gateway-load-balancer/) 后面的第三方设备，会在特定区域内部署。在 Amazon VPC 内或 Amazon VPC 之间传输的过滤和检查流量（也称为 [东西向流量 (east-west traffic)](https://en.wikipedia.org/wiki/East-west_traffic)）是一种有效用例，但本文不讨论。

在本帖中，我们将检查三个场景：

1. 单区域出站 (南北向) 检查
2. 多区域出站 (南北向) 检查，在所有区域中部署出站堆栈
3. 多区域出站 (南北向) 检查，使用地理聚类和边缘覆盖

## **先决条件**

本帖扩展了我们上一篇文章中介绍的概念，[使用 AWS Cloud WAN 服务插入简化全球安全检查 (Simplify global security inspection with AWS Cloud WAN service insertion)](https://aws.amazon.com/blogs/networking-and-content-delivery/simplify-global-security-inspection-with-aws-cloud-wan-service-insertion/)。那篇文章涵盖了关键优势和架构模式，用于区域间、区域内和段间场景。在继续本帖之前，您必须充分了解之前讨论的 [全球和核心网络关键概念 (Global and core network key concepts)](https://docs.aws.amazon.com/network-manager/latest/cloudwan/what-is-cloudwan.html#cloudwan-concepts-key)。

在所有场景中，虽然我们展示了 IPv4 寻址，但 AWS Cloud WAN 支持 IPv4 和 IPv6 寻址。

## **场景 1: 单区域出站 (南北向) 检查**

图 1 显示了场景 1，其中包含一个单区域 (区域 1) 和两个 VPC：

1. Prod VPC 1 (10.1.0.0/16)：附加到 Prod 段。
2. Inspection VPC 1 (100.64.1.0/24)：附加到 Inspection NFG，并托管安全设备。

在此场景中，所有从 Prod VPC 1 退出到互联网的流量首先路由通过 Inspection VPC 1。返回流量遵循相同的路径。此检查过程通过 Inspection NFG 的服务插入实现，从而通过筛选所有互联网出站流量来提升安全。

![图 1: 单区域的互联网出站检查](https://d2908q01vomqb2.cloudfront.net/5b384ce32d8cdef02bc3a139d4cac0a22bb029e8/2025/03/29/Fig1-1310.png)

图 1: 单区域的互联网出站检查

我们可以通过一个演练来概述在 us-east-1 区域中使用 AWS Cloud WAN 服务插入的 [网络功能组 (NFG)](https://docs.aws.amazon.com/network-manager/latest/cloudwan/cloudwan-policy-network-function-groups.html) 将安全结构插入 Prod VPC 1 和互联网之间出站流量路径的过程。

**步骤 1:** 使用以下示例创建 InspectionNFG NFG：
    
    "network-function-groups": [
        {
          "name": "InspectionNFG",
          "description": "Route segment traffic to the inspection VPC",
          "require-attachment-acceptance": false
        }
      ],
    

**步骤 2:** 创建 Inspection VPC 1 附加，并添加键值标签。您可以使用 [AWS Command Line Interface (AWS CLI, AWS CLI)](https://aws.amazon.com/cli/) 通过以下示例创建附加：
    
    aws networkmanager create-vpc-attachment \
    --core-network-id "<core-network-id>" \
    --vpc-arn "<vpc-arn>" \
    --subnet-arns "<subnet-arn>" \
    --tags Key=environment,Value=InspectionNFG
    

**步骤 3:** 附加策略会分析我们在步骤 2 中指定的 Cloud WAN 附加键值标签，而不是与 VPC 资源相关的标签。以下示例附加策略会分析附加并将带有标签 “environment”: “InspectionNFG” 的附加映射到 InspectionNFG NFG。在使用段操作插入流量路径之前，必须将 Inspection VPC 1 附加映射到 InspectionNFG NFG：
    
    "attachment-policies": [
        {
          "rule-number": 100,
          "condition-logic": "or",
          "action": {
            "add-to-network-function-group": "InspectionNFG"
          },
          "conditions": [
            {
              "type": "tag-value",
              "value": "InspectionNFG",
              "operator": "equals",
              "key": "environment"
            }
          ]
        },
    ],
    

**步骤 4:** 使用以下示例 [segment-actions send-to 参数](https://docs.aws.amazon.com/network-manager/latest/cloudwan/cloudwan-policies-json.html#cloudwan-segment-actions-json) 将 InspectionNFG NFG 插入互联网出站流量路径。此步骤应在创建 Inspection VPC 1 附加并将其关联到 InspectionNFG NFG 之后执行：
    
    "segment-actions": [
        {
          "segment": "Prod",
          "action": "send-to",
          "via": {
            "network-function-groups": [
              "InspectionNFG"
            ]
          },
          "when-sent-to": {
            "segments": "Prod"
          }
        }
      ]
    

当您使用 send-to 参数将 InspectionNFG NFG 插入流量路径时，会在应用该操作的段上添加默认路由。因此，所有从 Prod 段的互联网出站流量都会通过 Inspection VPC 1 中的防火墙进行引导。AWS Cloud WAN 会执行以下操作：

- 将 Prod VPC 1 CIDR (10.1.0.0/16) 传播到 InspectionNFG 路由表中，以 Prod VPC 1 附加作为下一跳。在同一区域内传播的路由会将其下一跳重定向到本地 NFG 附加。
- 在 Prod 段路由表中添加 0.0.0.0/0 和 ::/0 路由，并将下一跳设置为本地 NFG 附加。

![图 2: 互联网出站检查流量流动](https://d2908q01vomqb2.cloudfront.net/5b384ce32d8cdef02bc3a139d4cac0a22bb029e8/2025/03/29/Fig2-1310.png)

图 2: 互联网出站检查流量流动

# **数据包演练**

此演练 (图 2) 显示了 Prod VPC 1 中的资源在同一区域内向互联网发送流量时的数据包流动：

- **(A)** 当 Prod VPC 1 中的资源启动到互联网目的地的连接时，它会在 Prod VPC 1 路由表中执行查找。数据包匹配以核心网络 [Amazon Resource Name (ARN)](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference-arns.html) 为目标的默认路由条目，随后路由到核心网络。
- **(B)** 到达核心网络后，会在 Prod 段路由表中执行查找，以 US East-1 作为边缘位置 (因为 Prod VPC 1 与 Prod 段关联)。数据包匹配默认 0.0.0.0/0 CIDR 条目，该条目以 Inspection VPC 附加为目标。因此，数据包路由到 Inspection VPC。
- **(C)** Inspection VPC 中的核心网络 ENI 会将数据包转发到防火墙/安全设备 ([AWS Network Firewall](https://aws.amazon.com/network-firewall/) 或 GWLB) 通过防火墙端点 (未在此显示) 进行检查。如果数据包被允许，则端点会将其转发到一个 [Network Address Translation (NAT) 网关](https://docs.aws.amazon.com/vpc/latest/userguide/vpc-nat-gateway.html) (未显示)。然后，NAT 网关会将数据包转发到一个 Internet Gateway (IGW)，IGW 会将其发送到互联网。
- **(D)** 对于返回流量，IGW 会将数据包发送回同一可用区 (AZ) 中的 NAT 网关，该 AZ 是流量起源地。
- **(E)**, **(F)** 返回流量沿相反方向遵循相同的路径。

## **场景 2: 多区域出站 (南北向) 检查，在所有区域中部署出站堆栈**

图 3 显示了资源分布在三个 AWS Regions：us-east-1、us-west-1 和 us-west-2。每个 AWS Region 包含两个 VPC：一个 Prod VPC 和一个 Inspection VPC。Prod VPCs 映射到 Prod 段，而 Inspection VPCs 映射到 InspectionNFG NFG。此多区域部署扩展了前面描述的单区域架构。

![图 3: 多区域架构，在所有 AWS Regions 中部署出站堆栈](https://d2908q01vomqb2.cloudfront.net/5b384ce32d8cdef02bc3a139d4cac0a22bb029e8/2025/03/29/Fig3-1310..png)

图 3: 多区域架构，在所有 AWS Regions 中部署出站堆栈

AWS Cloud WAN [段 (segments)](https://docs.aws.amazon.com/network-manager/latest/cloudwan/what-is-cloudwan.html) 可以配置为全局或区域对象。此配置允许您设计路由，使每个 AWS Region 针对特定目标 CIDR 具有区域附加。因此，您可以控制出站流量的出口点。当我们使用 send-to 参数将 InspectionNFG NFG 插入流量路径时，AWS Cloud WAN 会向应用该操作的段添加默认路由。此默认路由使用相应的区域 Inspection VPC 附加作为下一跳。

这种路由行为是因为，对于具有相同目标 IP 地址但不同目标的路由，AWS Cloud WAN 会优先选择相同/本地区域的路由，而非远程区域路由。有关此行为的更多详细信息，请参阅 [AWS Cloud WAN 文档](https://docs.aws.amazon.com/network-manager/latest/cloudwan/what-is-cloudwan.html) 中的 [Route Evaluation](https://docs.aws.amazon.com/network-manager/latest/cloudwan/cloudwan-create-attachment.html#cloudwan-route-evaluation) 部分。

![图 4: 场景 2 的流量流动](https://d2908q01vomqb2.cloudfront.net/5b384ce32d8cdef02bc3a139d4cac0a22bb029e8/2025/03/29/Fig4-1310.png)

图 4: 场景 2 的流量流动

# **数据包演练**

数据包流动 (图 4) 遵循场景 1 中概述的过程。在每个 AWS Region 中，资源通过其指定的区域防火墙连接到互联网 (标签 **(A)**)。

## **场景 3: 多区域出站 (南北向) 检查，使用地理聚类和边缘覆盖**

对于互联网出站，您可以选择两种方法：每个 AWS Region 部署一个出站 VPC (安全堆栈) (如场景 2 所述)，或在单个区域中部署一个出站 VPC 来检查和处理来自多个 AWS Regions 的流量。例如，您可以根据地理区域 (如 AMER 或 EMEA) 部署防火墙和 NAT 网关，以管理每个相应 AWS Region 的出站流量。

# **无边缘覆盖**

图 5 演示了场景 3，其中区域 1 (us-east-1) 和区域 2 (us-west-2) 各有自己的 Inspection VPCs 和防火墙，而区域 3 (us-west-1) 没有。

![图 5: 多区域架构，未在所有 AWS Regions 中部署出站堆栈](https://d2908q01vomqb2.cloudfront.net/5b384ce32d8cdef02bc3a139d4cac0a22bb029e8/2025/03/29/Fig5-1310..png)

图 5: 多区域架构，未在所有 AWS Regions 中部署出站堆栈

当您在某个 AWS Region 中部署出站 VPC 来检查和处理来自多个 AWS Regions 的流量时，必须仔细考虑下一跳选择。默认情况下，当从多个核心网络边缘 (CNEs) 接收到具有类似属性的多个附加时，系统会使用一个 [有序列表](https://docs.aws.amazon.com/network-manager/latest/cloudwan/what-is-cloudwan.html#cloudwan-available-regions) 来选择哪个区域 (以及哪个附加) 转发流量。这可能会导致次优的路由行为。

例如，虽然 us-west-1 (N. California) 地理上更接近 us-west-2 (Oregon)，但默认情况下，us-west-1 (N. California) 的出站流量会通过 us-east-1 (N. Virginia) 防火墙路由，而不是更近的 us-west-2 (Oregon) 防火墙。这是因为根据 [有序列表](https://docs.aws.amazon.com/network-manager/latest/cloudwan/what-is-cloudwan.html#cloudwan-available-regions)，us-east-1 的优先级高于 us-west-2。此行为如图 6 所示。

![图 6: 无边缘覆盖的流量流动](https://d2908q01vomqb2.cloudfront.net/5b384ce32d8cdef02bc3a139d4cac0a22bb029e8/2025/04/02/Fig6-1310.png)

图 6: 无边缘覆盖的流量流动

# **数据包演练**

数据包流动 (图 6) 类似于场景 2。在 us-east-1 和 us-west-2 Regions 中，资源通过其指定的区域防火墙连接到互联网 (标签 **(A)**)。然而，对于 us-west-1 (没有自己的区域出站 VPC)，资源通过 us-east-1 中的防火墙连接到互联网 (标签 **(B)**)。

# **有边缘覆盖**

AWS Cloud WAN 服务插入的边缘覆盖属性允许您修改默认的下一跳选择过程。在配置 AWS Cloud WAN 策略时，您可以使用边缘覆盖来重定向来自特定源区域的流量，通过您首选的 AWS Region 中的防火墙 (Inspection VPC)。以下是边缘覆盖策略配置的示例：
    
    "segment-actions": [
        {
          "action": "send-to",
          "segment": "Prod",
          "via": {
            "network-function-groups": [
              "InspectionNFG"
            ],
            "with-edge-overrides": [
              {
                "edge-sets": [
                  [
                    "us-west-1"
                  ]
                ],
                "use-edge-location": "us-west-2"
              }
            ]
          },
          "when-sent-to": {
            "segments": "Prod"
          }
        }
      ],
    

使用边缘覆盖，您可以将 us-west-1 Region 的流量路由通过 us-west-2 Region 中的防火墙，而不是 us-east-1 Region 中的防火墙。图 7 显示了此配置。

![图 7: 有边缘覆盖的流量流动](https://d2908q01vomqb2.cloudfront.net/5b384ce32d8cdef02bc3a139d4cac0a22bb029e8/2025/04/02/Fig7-1310.png)

图 7: 有边缘覆盖的流量流动

# **数据包演练**

数据包流动 (图 7) 类似于场景 2。在 us-east-1 和 us-west-2 Regions 中，资源通过其指定的区域防火墙连接到互联网 (标签 **(A)**)。然而，对于 us-west-1 (没有自己的区域出站 VPC)，资源通过 us-west-2 中的防火墙连接到互联网，而不是 us-east-1，由于边缘覆盖配置 (标签 **(B)**)。

## **注意事项**

**** 有关详细信息，请参阅以下内容：

- AWS Cloud WAN [文档](https://docs.aws.amazon.com/network-manager/latest/cloudwan/what-is-cloudwan.html)
- 上一篇文章 “[使用 AWS Cloud WAN 服务插入简化全球安全检查](https://aws.amazon.com/blogs/networking-and-content-delivery/simplify-global-security-inspection-with-aws-cloud-wan-service-insertion/)” 中的 [注意事项](https://aws.amazon.com/blogs/networking-and-content-delivery/simplify-global-security-inspection-with-aws-cloud-wan-service-insertion/) 部分

## **结论**

本帖探讨了使用 AWS Cloud WAN 服务插入的互联网出站 (南北向) 检查架构模式。此功能简化了流量引导，通过部署在 VPC 或本地网络中的网络功能 (如防火墙和安全设备)。使用 AWS Network Manager 或 JSON，您可以定义策略和 NFGs 来重定向段之间的流量，通过指定附加。这支持互联网出站，以及区域内和区域间流量流动。有关更多信息，请参阅 [AWS Cloud WAN 文档](https://docs.aws.amazon.com/network-manager/latest/cloudwan/what-is-cloudwan.html)。

## **作者介绍**

![riz-2.jpg](https://d2908q01vomqb2.cloudfront.net/5b384ce32d8cdef02bc3a139d4cac0a22bb029e8/2021/02/10/riz-2.jpeg)

### Rizwan Mushtaq

Rizwan 是 AWS 的首席解决方案架构师。他帮助客户使用 AWS 服务设计创新、弹性且性价比高的解决方案。他拥有威奇托州立大学的电气工程硕士学位。

![pmankad-headshot1.jpg](https://d2908q01vomqb2.cloudfront.net/5b384ce32d8cdef02bc3a139d4cac0a22bb029e8/2020/11/06/pmankad-headshot1.jpg)

### Pratik R. Mankad

Pratik 是 AWS 的网络解决方案架构师。他对网络技术充满热情，并喜欢创新以帮助解决客户问题。他喜欢设计解决方案并提供技术指导，以帮助客户和合作伙伴实现技术与业务目标。

![umairahd.jpg](https://d2908q01vomqb2.cloudfront.net/5b384ce32d8cdef02bc3a139d4cac0a22bb029e8/2025/03/29/umairahd.jpg)

### Umair Ahmed

Umair Ahmed 是 AWS 战略账户的高级解决方案架构师。在这个角色中，Umair 帮助企业客户构建高度可伸缩、安全且高性能的云解决方案，以实现基础设施和应用的现代化。Umair 的深厚技术专长和以客户为中心的理念，使他成为 AWS 一些最复杂客户的可信顾问。

<!-- AI_TASK_END: AI全文翻译 -->

