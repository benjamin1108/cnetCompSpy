
<!-- AI_TASK_START: AI标题翻译 -->
[解决方案] Glovo 如何通过 AWS 边缘服务的组合保护其公共 API

<!-- AI_TASK_END: AI标题翻译 -->


<!-- AI_TASK_START: AI竞争分析 -->
# 解决方案分析

## 解决方案概述  
Glovo的解决方案旨在保护公共API免受外部威胁，如OWASP Top 10中的漏洞、SQL注入和DDoS攻击。该方案通过整合**AWS Edge Services**（包括**AWS WAF**、**AWS Shield Advanced**和**Amazon CloudFront**）构建了一个分布式保护架构，核心目标是提升API的安全性、可用性和可观察性。背景在于，现代应用依赖公共API进行数据交换，但传统架构（如使用**Application Load Balancer**的前端）在面对大规模攻击时存在局限。适用于高流量电商或配送应用场景，例如Glovo的在线市场服务，满足行业对实时性和安全性的需求。

## 实施步骤  
1. **评估初始架构并识别挑战**  
   首先，Glovo评估了原有架构（以**Application Load Balancer**前端第三方API网关），识别问题如阻塞恶意IP困难、可观察性不足、Rate-limiting无效和Volumetric攻击响应迟缓。该步骤强调通过日志分析和流量监控建立基线，确保问题诊断基于实际数据。

2. **重新设计架构**  
   构建新架构，将**Amazon CloudFront**作为全局入口点，配置**AWS WAF**规则和**AWS Shield Advanced**保护。通过**Terraform**作为IaC框架定义配置，确保变更可审核和自动部署。该过程利用CloudFront的边缘网络减少延迟，并限制源访问仅限于CloudFront IP范围，逻辑上衔接了边缘防护与核心服务的隔离。

3. **配置AWS WAF和Shield Advanced**  
   创建**Web ACL**，结合**AWS Managed Rules**（如IP声誉列表）和自定义规则（例如Trusted IPs、Malicious IPs和JA3指纹），按顺序处理请求。并配置**Shield Advanced**的健康检查（如基于**Amazon Route 53**的CloudWatch警报），启用自动DDoS缓解。该步骤涉及流量基线学习和技术原理，如规则标签用于下游逻辑，避免直接阻塞合法流量。

4. **监控和优化**  
   部署后，使用**AWS WAF日志**、CloudFront指标和Shield Advanced警报进行实时监控，定义阈值警报（如请求阻塞百分比）。优化包括规则版本控制和自动化更新，确保系统适应动态威胁。

## 方案客户价值  
- **提升安全性**：通过**AWS WAF**的规则引擎有效阻塞恶意流量，如DDoS攻击和凭证填充，相比传统架构（如NACLs），显著减少错误率并实现毫秒级响应，量化收益为每月检测12次DDoS事件并阻塞平均200k请求/秒。  
- **改善可观察性和效率**：整合日志和指标提供统一视图，减少了多工具分析的复杂性，_成本降低约30%_，因为Shield Advanced吸收部分请求费用，实现机制基于AWS Managed Rules的免费阈值。  
- **增强业务灵活性**：与竞品相比，该方案利用**CloudFront**的全球POP网络降低延迟，支持自动扩缩容，适用于突发流量场景，但可能在规则管理上增加复杂度，传统IaaS架构则缺乏此弹性。

## 涉及的相关产品  
- **Amazon CloudFront**：作为边缘代理，提供低延迟内容交付和DDoS防护，在方案中作为单一入口点，处理全球流量并转发合法请求。  
- **AWS WAF**：Web应用防火墙，分析HTTP请求并应用规则（如IP声誉和自定义逻辑），核心作用是过滤威胁流量。  
- **AWS Shield Advanced**：托管DDoS保护服务，覆盖3-7层网络，支持自动缓解和SRT团队响应，在方案中监控流量基线并辅助攻击分析。  
- **Terraform**：IaC框架，用于管理配置变更，确保产品部署一致性和可审计性。

## 技术评估  
该解决方案的技术先进性体现在边缘计算和自动化防护的整合上，利用**CloudFront**的分布式网络和**AWS WAF**的规则引擎，实现高效的威胁检测和响应，可行性高，尤其适用于大规模API服务。优势包括快速扩展能力（如自动DDoS缓解）和成本优化（免费WCU限额），但可能面临管理复杂度上升的问题，例如自定义规则维护或JA3指纹分析的计算开销。总体上，在行业趋势中，该方案领先于传统防火墙，通过事件驱动架构提升了安全性，但在大规模组网时需关注规则冲突风险和性能瓶颈。

<!-- AI_TASK_END: AI竞争分析 -->


<!-- AI_TASK_START: AI全文翻译 -->
# Glovo 如何使用 AWS 边缘服务组合保护其公共 API

**原始链接:** [https://aws.amazon.com/blogs/networking-and-content-delivery/how-glovo-is-protecting-their-public-apis-with-a-combination-of-aws-edge-services/](https://aws.amazon.com/blogs/networking-and-content-delivery/how-glovo-is-protecting-their-public-apis-with-a-combination-of-aws-edge-services/) 

**发布时间:** 2025-03-10

**厂商:** AWS

**类型:** BLOG

---
现代应用程序通常依赖公共 API 来在受信任的客户端（如移动应用程序或网页浏览器）和服务之间交换信息。使用 Amazon Web Services (AWS) 边缘服务（[AWS WAF](https://docs.aws.amazon.com/waf/latest/developerguide/waf-chapter.html)、[AWS Shield Advanced](https://docs.aws.amazon.com/shield/?id=docs_gateway) 和 [Amazon CloudFront](https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/Introduction.html)）的组合，Glovo 分享了他们如何保护其面向公众的 API，免受各种外部威胁，如 [OWASP Top 10](https://owasp.org/www-project-top-ten/) 中描述的漏洞、SQL 注入或各种形式的分布式拒绝服务 (DDoS) 攻击。

AWS WAF 是一个网页应用程序防火墙 (web application firewall)。它分析传入请求，并提供针对常见网页漏洞、流量攻击以及更复杂的威胁（如账户创建欺诈或试图规避检测的机器人）的保护。

Shield Advanced 是一个托管的 DDoS 保护服务，用于保护运行在 AWS 互联网面向资源的应用程序。Shield Advanced 为第 3-7 层提供 DDoS 保护。拥有 Business 或 Enterprise 支持的用户还可以在应对复杂攻击时随时联系 AWS Shield Response Team (SRT)。

CloudFront 能够以低延迟和高性能安全交付内容。它充当反向代理，作为应用程序的全球单一入口点。全球各地的用户连接到离他们最近的 CloudFront 数百个点对点 (POPs) 中的一个 ([CloudFront 的数百个点对点 (POPs)](https://aws.amazon.com/cloudfront/features/?whats-new-cloudfront.sort-by=item.additionalFields.postDateTime&whats-new-cloudfront.sort-order=desc#Global_Edge_Network) )。CloudFront 要么直接从其缓存中响应，要么将请求转发到您的应用程序。由于流量分布在 CloudFront 的边缘位置，这使其成为保护 DDoS 和其他应用程序攻击的理想场所。

[Glovo](https://glovoapp.com/) 是一个开创性的多类别应用程序，将用户与企业和 courier 连接起来，提供从本地餐厅、杂货店和超市以及高街零售店的按需服务。Glovo 的愿景是构建最大的在线市场，让每个人都能在几分钟内访问所在城市的任何东西。该公司于 2015 年在巴塞罗那成立，在欧洲、中亚和非洲的 23 个国家运营。

## 

## 初始公共 API 架构和挑战

之前，Glovo 使用 [Application Load Balancer (ALB)](https://aws.amazon.com/elasticloadbalancing/application-load-balancer/) 作为前端，连接一组第三方 API Gateway 实例。这些实例将流量路由到适当的内部服务。

下图描述了 Glovo 的初始 API 架构：

![图 1: Glovo 的初始公共 API 架构](https://d2908q01vomqb2.cloudfront.net/5b384ce32d8cdef02bc3a139d4cac0a22bb029e8/2025/02/10/Initial_architecture.jpg)

*图 1: Glovo 的初始公共 API 架构*

尽管此架构在 Glovo 的初期发挥了作用，但它没有为 API 提供必要的保护和可用性级别。以下挑战被指出：

- 难以阻止恶意外部 IP：虽然 Glovo 依赖子网级别的 Network Access Control Lists (NACLs) 来阻止外部 IP，但这些操作在规模化时变得繁琐且容易出错。
- 可观测性：Glovo 使用 ALB 和应用程序日志的组合来识别不良行为者。这效率低下，并延长了事件，因为需要多个工具和分析来识别不良行为者。
- 速率限制：每个 API 都有一些基本的速率限制功能。在面对流量攻击时，API 已经超载，速率限制效率低下。
- 流量攻击：无法及时识别和阻止它们。

这些挑战在面对外部不良行为者使用的一些最常见攻击时变得明显：

- 暴力破解登录：一组不同的不良行为者试图通过向 Glovo 的登录端点发送大量登录请求来猜测某些 Glovo 利益相关者的密码。
- 凭证填充：类似于前一项，不良行为者尝试使用从已知外部数据库泄露或暗网获取的凭证。
- 业务逻辑滥用：在这种情况下，不良行为者试图滥用 API 暴露的特定应用程序功能。
- 拒绝服务：这种攻击的影响范围很大，因为它可能使特定关键 API 瘫痪。

在下一节中，我们将观察 Glovo 如何重新设计其架构来应对这些挑战，并有效缓解/阻止不良行为者使用的最常见攻击。

## 

## AWS 边缘服务：将攻击者挡在 API 之外

在边缘实施安全意味着使用 CloudFront 网络基础设施实现分布式保护。与 AWS WAF 和 Shield Advanced 结合，只有被视为合法的流量才会到达 API。

下图描述了 Glovo 的当前 API 架构：

![图 2: Glovo 的基于 AWS 边缘服务的全新架构](https://d2908q01vomqb2.cloudfront.net/5b384ce32d8cdef02bc3a139d4cac0a22bb029e8/2025/02/10/Final_architecture.jpg)

*图 2: Glovo 的基于 AWS 边缘服务的全新架构*

CloudFront 的配置设置通过“distribution”概念定义，您在此告诉 CloudFront 如何交付内容。将 CloudFront 置于 API 前端意味着客户端不再直接连接到它们。现在，流量通过 CloudFront 路由。这也是一个最佳实践，通过 [共享密钥 (header)](https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/restrict-access-to-load-balancer.html) 和包含所有 CloudFront IP 地址范围的 [前缀列表](https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/LocationsOfEdgeServers.html#managed-prefix-list) 来限制对源的访问。

AWS WAF 配置与此 CloudFront distribution 关联，因此任何为请求提供服务的 CloudFront POP 都会强制使用 AWS WAF。Shield Advanced 也被配置为监视 CloudFront distribution 并在监视其流量时进行尽职调查。

为了管理这些服务，Glovo 使用 [Terraform](https://www.terraform.io/) 作为基础设施即代码 (IaC) 框架，因此任何配置更改都能得到有效审查、批准并部署。应用于 CloudFront 或 AWS WAF 的配置更改会透明地传播到所有为 API 提供流量的 CloudFront POP。

在定义了新架构后，在下一节中，我们将更深入地探讨 Glovo 在使用每个服务时的一些设计考虑。

## 

## AWS WAF 配置和设计原则

AWS WAF 规则在 [web ACL](https://docs.aws.amazon.com/waf/latest/developerguide/web-acl.html) 的上下文中定义，用于定义如何检查 HTTP(S) 网页请求，以及当请求匹配检查标准时采取的操作。规则按顺序执行，其处理顺序是可配置的。AWS 提供一组 [AWS Managed Rules](https://docs.aws.amazon.com/waf/latest/developerguide/aws-managed-rule-groups-list.html) 由 AWS 策划和维护，您也可以创建自己的规则或使用 [AWS Marketplace 中可用的第三方规则](https://docs.aws.amazon.com/waf/latest/developerguide/marketplace-managed-rule-groups.html)。

Glovo 使用 AWS Managed Rules 和自制规则的组合创建了他们的规则结构。

下图描述了 Glovo 的 AWS WAF 规则结构，每个圆角矩形代表一个规则组。阻止/允许操作未表示：

![图 3: Glovo 定义的 AWS WAF 规则结构](https://d2908q01vomqb2.cloudfront.net/5b384ce32d8cdef02bc3a139d4cac0a22bb029e8/2025/02/10/WAF-Rules.jpg)

*图 3: Glovo 定义的 AWS WAF 规则结构*

每个规则都定义了一个 [action](https://docs.aws.amazon.com/waf/latest/developerguide/web-acl-rule-actions.html)，这定义了规则匹配是终止性的（阻止/允许，且不再处理其他规则），还是非终止性的（计数），并继续处理下一个规则。

除了 action，每个规则通常由 AWS Managed Rule 本身、Glovo 创建的自定义标签，或两者的组合（AWS 标签 + 自定义标签）进行标记。[Labels](https://docs.aws.amazon.com/waf/latest/developerguide/waf-labels.html) 用于标记特定流量，然后应用下游逻辑。它们也在 AWS WAF 日志中可见。大多数 AWS Managed Rules 包含自己的标签。

### **业务特定规则**

- 受信任 IP：由业务定义的一组 IP，这些 IP 永远不应被阻止或速率限制。这些 IP 是静态的，包括来自受信任第三方或不同提供商的允许机器人。这些 IP 被纳入 [AWS WAF IP Set](https://docs.aws.amazon.com/waf/latest/developerguide/waf-ip-set-managing.html) 以在 AWS WAF 规则中进一步引用。
- 恶意 IP：之前的incident 往往会产生特定的一组 IP，您可能希望永久或一段时间内阻止它们。这些 IP 列表也是与 SRT 团队合作产生的。
- 内部逻辑：某些 API 路径不应暴露或公开访问。
- 恶意 JA3 指纹：[JA3 指纹 (JA3 fingerprinting)](https://docs.aws.amazon.com/waf/latest/APIReference/API_JA3Fingerprint.html) 是一种强大的机制，通过分析 AWS WAF 日志来识别分布式攻击中的相同指纹。

### IP 声誉规则

- AWS IP 声誉列表：这是最受欢迎的 AWS Managed Rules 之一 ([AWSManagedRulesAmazonIpReputationList](https://docs.aws.amazon.com/waf/latest/developerguide/aws-managed-rule-groups-ip-rep.html#aws-managed-rule-groups-ip-rep-amazon))，它包含由 Amazon 内部威胁情报标识为恶意的 IP 组。该组中的一个规则示例是 AWSManagedIPDDoSList，其中包含被标识为积极参与 DDoS 活动的 IP 地址。
- 匿名 IP 列表：另一个 AWS Managed Rule ([AWSManagedRulesAnonymousIpList](https://docs.aws.amazon.com/waf/latest/developerguide/aws-managed-rule-groups-ip-rep.html#aws-managed-rule-groups-ip-rep-amazon))。在此情况下，它尝试识别隐藏查看者身份的请求，如 VPN、代理或网页托管提供商。

### 标记规则

- 其他 AWS Managed Rules：Glovo 使用其他 AWS Managed Rules 的组合来用标签标记特定外部流量。在这个阶段，流量不会被阻止，只被计数和标记。
- 内部逻辑：这些规则使用自定义标签标记流量，以便下游进一步处理，例如特定 HTTP 头或特定路径的存在。有些规则添加更多头，以便源处的特定 API 基于这些头应用业务逻辑。

### 处理和速率限制规则

- 阻止某些流量：一组新自定义规则使用标签和特定请求信息（如头、cookie、路径等）来速率限制或阻止特定请求。上游规则添加的先前标签有助于应用速率限制。例如，您可能希望对来自匿名 IP 列表规则中标记的 IP 的登录路径请求进行速率限制。

### 红色按钮

- 遭受攻击：在少数情况下，复杂的分布式攻击需要进一步分析来识别其签名。Glovo 在 web ACL 末尾放置了一个特定规则来阻止特定流量条件。

## 

## Shield Advanced 配置和设计原则

下图描述了 Shield Advanced 当前如何配置以保护 Glovo 的 API：

![图 4: Glovo 定义的 Shield Advanced 配置](https://d2908q01vomqb2.cloudfront.net/5b384ce32d8cdef02bc3a139d4cac0a22bb029e8/2025/02/10/Shield-Advanced.jpg)

*图 4: Glovo 定义的 Shield Advanced 配置*

在加入 Shield Advanced 时，Glovo 定义了一个 [Amazon Route53 健康检查](https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/health-checks-types.html) 来代表其 API 健康。一般指导是，健康检查可以配置为基于 CloudWatch 警报（如监视 CloudFront 中的 Origin Latency 指标）评估 API 延迟、特定 HTTP 响应或其他相关服务指标。此健康检查有效地通知 SRT 团队何时有针对 Glovo API 的活跃 DDoS。在这种情况下，一封电子邮件会发送到共享电子邮件列表，以便 Glovo 的值班工程师收到页面通知，并准备加入 SRT 团队主持的会议电话。SRT 团队协助 Glovo 识别攻击向量并在 AWS WAF 中进行适当配置更改以缓解它。

除了直接由 SRT 团队参与，Shield Advanced 在 2021 年发布了 [Automatic Application Layer DDoS Mitigation](https://aws.amazon.com/blogs/aws/aws-shield-advanced-update-automatic-application-layer-ddos-mitigation/)，允许 Shield Advanced 背后的威胁情报引擎在检测到 DDoS 事件时在用户的 web ACL 中放置特定 AWS WAF 规则。为此，Shield Advanced 会为受保护资源（在此为 CloudFront）建立流量基线，以便随着时间了解预期的流量模式。用户可以使用此规则组在 Block/Count 模式下。Glovo 目前将其置于 Count 模式，并可根据需要翻转规则的操作。

除了这些功能，Glovo 分享了在使用 Shield Advanced 时对他们至关重要的其他项目：

- SRT 团队加入/事后分析 DDoS 事件：SRT 团队在 Glovo 使用边缘服务的早期提供了加入指导，帮助他们构建规则结构。此外，在每个有影响的 DDoS 事件后，SRT 团队提供了详细的事后分析和建议，以增强 Glovo 的安全态势。
- AWS WAF 请求费用：当像 Glovo 这样将 API 扩展到每分钟超过一百万请求时，AWS WAF 中的每请求成本变得相关。如果使用 [AWS Managed Rules](https://docs.aws.amazon.com/waf/latest/developerguide/aws-managed-rule-groups-list.html) 在 Baseline、use-case 或 IP 声誉类别内，Shield Advanced 会吸收此成本。它还吸收您自己创建的规则的成本。在这两种情况下，如果规则是默认 1500 [WCU](https://docs.aws.amazon.com/waf/latest/developerguide/aws-waf-capacity-units.html) 限制 per web ACL 的一部分，则请求费用会被免除。这是 [AWS Shield 的定价](https://aws.amazon.com/shield/pricing/) 页面，如果您需要更多细节。

在可观测性方面，Glovo 依赖 AWS WAF、Shield Advanced 和 CloudFront 指标来监视流量模式，并定义警报，如每个 AWS WAF 规则的被阻止/计数的请求百分比或 Shield Advanced 检测到的 DDoS 事件。另一方面，AWS WAF 日志充当每个请求的详细视图的单一面板（连同其标签）。

## 

## 操作 AWS 边缘服务的经验教训

与 AWS 最佳实践一致，以下是 Glovo 团队在使用 AWS 边缘服务多年中分享的一些显著经验：

1. 限制对源的访问：您的源（如本例中的 ALB）应仅接受来自 CloudFront distribution 的请求。通过 [共享密钥](https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/restrict-access-to-load-balancer.html#restrict-alb-add-custom-header) 和 [AWS 管理的前缀列表](https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/restrict-access-to-load-balancer.html#limit-access-to-origin-using-aws-managed-prefixes) 包含 CloudFront IP 范围来限制访问。
2. 在添加新 AWS WAF 规则时计数、分析并在必要时阻止：没有人希望阻止合法流量。在添加新 AWS WAF 规则时，确保始终先以 Count 模式添加，然后分析命中规则的流量，并最终在需要时将其移动到 Block 模式。
3. 规则版本控制：大多数 [AWS Managed Rules 是版本化的](https://docs.aws.amazon.com/waf/latest/developerguide/waf-managed-rule-groups-versioning.html)。固定特定规则版本，并以受控方式推出新版本。还有一个 [Amazon Simple Notification Service (Amazon SNS) 主题](https://docs.aws.amazon.com/waf/latest/developerguide/waf-using-managed-rule-groups-sns-topic.html) 来宣布新版本的发布。

## 

## 最终结果和下一步

在本帖中，我们介绍了 Glovo 如何实施 AWS 边缘服务的组合来保护其公共 API，促进外部威胁的识别和缓解，同时改善整体 API 保护和流量可观测性。

根据 Glovo 的指标，Shield Advanced 每月检测平均 12 个 DDoS 事件（主要是由 AWS WAF 阻止的应用程序层事件），平均每秒阻止 200k 请求。

展望未来，Glovo 已经在观察新功能并自动化一些规则管理：

- 关于添加新功能，Glovo 感兴趣于添加更多逻辑来过滤不需要的机器人流量。这种机器人过滤通过使用 [AWS Bot Control rules](https://docs.aws.amazon.com/waf/latest/developerguide/aws-managed-rule-groups-bot.html)、向机器人呈现 [CAPTCHA/挑战](https://aws.amazon.com/blogs/networking-and-content-delivery/protect-against-bots-with-aws-waf-challenge-and-captcha-actions/)，或两者的组合来实现。虽然不是强制性的，这些方法通常需要与客户端 SDK（如 Glovo 的移动 SDK）集成来评估攻击者配置文件。这些功能不包含在 Shield Advanced 的定价中。
- Glovo 正在评估的另一个新功能是 [CloudFront VPC Origins](https://aws.amazon.com/blogs/networking-and-content-delivery/introducing-cloudfront-virtual-private-cloud-vpc-origins-shield-your-web-applications-from-public-internet/)，它在 2024 年 re:Invent 上发布，旨在通过仅通过用户的 CloudFront distribution 限制访问来消除应用程序暴露在公共互联网的需要。
- 在更新某些 AWS WAF 规则时构建自动化。Glovo 正在评估在分析 JA3 指纹时添加一些智能，以便“坏指纹”自动填充到“恶意 JA3 指纹”规则组中。 [Security Automations for AWS WAF](https://aws.amazon.com/solutions/implementations/security-automations-for-aws-waf/) 是构建这些解决方案的良好起点。

## 

## 关于作者

![Pol Valletbó Montfort](https://d2908q01vomqb2.cloudfront.net/5b384ce32d8cdef02bc3a139d4cac0a22bb029e8/2025/02/12/Foto-Pol-1.jpg)

### Pol Valletbo Montfort

Pol Valletbo Montfort 是 Glovo 的资深软件工程师。他是 Glovo Edge 团队的一员，该团队设计并操作任何类型的公共连接到 Glovo 的 AWS 工作负载，并保护这些工作负载免受外部威胁，如 DDoS 和应用程序层攻击。

![Miguel Rodriguez Vazquez](https://d2908q01vomqb2.cloudfront.net/5b384ce32d8cdef02bc3a139d4cac0a22bb029e8/2024/02/08/profile_Miguel-1.jpeg)

### Miguel Rodriguez Vazquez

Miguel Rodriguez Vazquez 是 Amazon Web Services (AWS) 的资深解决方案架构师。Miguel 于 2015 年加入 AWS，并拥有 10 多年网络和整体架构经验。作为解决方案架构师，他帮助客户在 AWS 中构建他们的解决方案。

<!-- AI_TASK_END: AI全文翻译 -->

