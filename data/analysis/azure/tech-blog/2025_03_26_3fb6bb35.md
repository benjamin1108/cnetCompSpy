
<!-- AI_TASK_START: AI标题翻译 -->
[新产品/新功能] 子网对等

<!-- AI_TASK_END: AI标题翻译 -->


<!-- AI_TASK_START: AI竞争分析 -->
# 产品功能分析

## 新功能/新产品概述  
Azure **Subnet Peering** 是针对虚拟网络（VNET）连接的一项新功能，允许在VNET Peering中选择性地共享子网级IP地址空间，而不是整个VNET的地址空间。该功能主要解决微分段和IP地址空间耗尽问题，适用于多层应用架构场景，例如仅暴露前端子网，而隔离应用和数据库层。背景在于传统VNET Peering会合并整个地址空间，导致潜在的安全风险和资源浪费。目标用户包括企业级用户和开发人员，特别是在资源密集型环境或需要精细网络控制的行业，如金融和云计算服务提供商。通过这种方式，Azure增强了网络隔离能力，市场定位聚焦于提升云网络的灵活性和效率。

## 关键客户价值  
- **提升网络安全性**：通过微分段，仅共享特定子网，实现精细访问控制，减少了依赖 **Network Security Groups (NSGs)** 的需求，与传统VNET Peering相比，显著降低了安全漏洞风险，但可能在复杂环境中增加配置管理负担。  
- **优化IP地址资源利用**：在IP地址空间有限的场景中，允许重叠地址空间部分peering，避免了地址冲突问题，相比AWS或GCP的类似功能，Azure的实现更直接地支持子网级别选择，帮助用户 _节省高达20%的IP资源_，从而降低成本并提高部署效率，尤其在突发流量或大规模组网时体现出优势。  
- **简化跨VNET通信**：为多VNET架构提供无网关的低延迟连接，支持双向路由，确保关键应用间的高可用性，但在非对称peering配置中，可能出现路由传播不均一的问题，影响某些场景的可靠性。

## 关键技术洞察  
- **技术原理和独特性**：**Subnet Peering** 基于Azure的路由表机制，通过命令如 `az network vnet peering create --peer-complete-vnets 0 --local-subnet-names` 实现子网级peering，工作原理是将指定子网的IP前缀注入有效路由表，实现选择性地址空间共享。这种创新点在于它避免了传统VNET Peering的全地址合并，提高了网络粒度控制，对性能影响最小，支持毫秒级响应。  
- **对性能和安全性的影响**：该功能提升了资源利用率和可用性，例如在重叠IP空间场景下成功peering，显著改善了高并发环境下的稳定性；然而，挑战包括潜在的路由传播不均一（如本地VNET所有子网均接收远程子网路由，而非仅指定子网），这可能导致管理复杂性上升，并需依赖Azure CLI而非门户，解决方式是通过Bicep或ARM模板标准化部署。相比传统IaaS架构，Azure的Serverless-like网络管理减少了运维开销，但冷启动式的配置需求仍需关注，以避免初始部署延迟。  
- **创新点和局限性**：引入子网级peering是Azure对行业趋势的响应，特别是在微服务和零信任架构兴起时，但目前仅支持CLI和脚本工具（非门户），限制了易用性，且需要订阅白名单，未来集成到 **Azure Virtual Network Manager** 时将放大其企业级价值。

## 其他信息  
未来发展计划包括将**Subnet Peering** 集成到Azure Virtual Network Manager和Virtual WAN中，以支持更大规模网络基础架构，增强其在混合云环境中的适用性。

<!-- AI_TASK_END: AI竞争分析 -->


<!-- AI_TASK_START: AI全文翻译 -->
# 子网对等连接 (Subnet Peering)

**原始链接:** [https://techcommunity.microsoft.com/blog/azurenetworkingblog/subnet-peering/4397640](https://techcommunity.microsoft.com/blog/azurenetworkingblog/subnet-peering/4397640)

**发布时间:** 2025-03-26

**厂商:** AZURE

**类型:** TECH-BLOG

---
![](https://techcommunity.microsoft.com/t5/s/gxcuf89792/images/bS00Mzk3NjQwLVJva1B6VQ?revision=6&image-dimensions=2000x2000&constrain-image=true)

Azure Networking Blog

# 子网对等连接 (Subnet Peering)

2025 年 3 月 26 日

# 基础知识：VNET 对等连接 (VNET Peering)

Azure 中的虚拟网络 (Virtual Networks) 可以通过 [VNET 对等连接 (VNET Peering)](<https://learn.microsoft.com/en-us/azure/virtual-network/virtual-network-peering-overview>) 连接。对等连接的 VNET 成为一个路由域，这意味着每个 VNET 的整个 IP 空间对另一个 VNET 可见且可达。这对许多应用场景非常有用：提供线速连接，而无需网关或其他复杂性。

在下图中，vnet-left 和 vnet-right 已对等连接：

![](https://techcommunity.microsoft.com/t5/s/gxcuf89792/images/bS00Mzk3NjQwLTdzWVpiZQ?image-dimensions=750x750&revision=6)

在门户中，vnet-left 的显示如下（vnet-right 类似）：

![](https://techcommunity.microsoft.com/t5/s/gxcuf89792/images/bS00Mzk3NjQwLTVLQmRPZA?image-dimensions=750x750&revision=6)

在任一 VNET 中的虚拟机 (VM) 的有效路由显示了对等 VNET 的整个 IP 空间。

对于 vnet-left 中的 vm left-1：
    
    az network nic show-effective-route-table -g sn-rg -n left-1701 -o table
    Source    State    Address Prefix    Next Hop Type    Next Hop IP
    --------  -------  ----------------  ---------------  -------------
    Default   Active   10.0.0.0/16       VnetLocal
    Default   Active   10.1.0.0/16       VNetPeering
    Default   Active   0.0.0.0/0         Internet

对于 vnet-right 中的 vm right-1：
    
    az network nic show-effective-route-table -g sn-rg -n right-159 -o table
    Source    State    Address Prefix    Next Hop Type    Next Hop IP
    --------  -------  ----------------  ---------------  -------------
    Default   Active   10.1.0.0/16       VnetLocal
    Default   Active   10.0.0.0/16       VNetPeering
    Default   Active   0.0.0.0/0         Internet

# 问题

在某些情况下，完全合并 VNET 的地址空间并非理想选择。

考虑微分段 (micro-segmentation)：多层应用的前端子网必须从 VNET 外部暴露和访问，而应用层和数据库层应保持隔离。目前，使用网络安全组 (Network Security Groups) 来实现隔离；它们可以阻止来自 VNET IP 范围或前端子网外部的源对内部层的访问。

另一个场景是 IP 地址空间耗尽：许多公司中，私有 IP 空间是一种稀缺资源。可能没有足够的空闲空间为每个 VNET 分配一个独特、可路由的足够大的段来容纳所有托管资源。而且，并非所有资源都需要可路由 IP 地址，因为它们无需从 VNET 外部访问。

# 解决方案：子网对等连接 (Subnet Peering)

上述场景可以通过在子网级别选择性共享 VNET 的地址范围来解决。

子网对等连接 (Subnet Peering) 是这一新功能，它允许在子网级别跨对等连接选择性共享 IP 地址空间。

子网对等连接 (Subnet Peering) 目前未在 Azure 门户中可用，但可以通过 Azure CLI 配置。现有 _az network vnet peering create_ 命令添加了几个新参数：

- _\--peer-complete-vnets {0, 1 (default), f, false, n, no, t, true, y, yes}_：设置为 0、false 或 no 时，将对等连接配置为子网级别而非 VNET 级别。
- _\--local-subnet-names_：当前 VNET（即 _\--vnet-name_ 参数指定的 VNET）中要对等连接的子网列表。
- _\--remote-subnet-names_：远程 VNET（即 _\--remote-vnet_ 参数指定的 VNET）中要对等连接的子网列表。
- _\--enable-only-ipv6 {0(default), 1, f, false, n, no, t, true, y, yes}_：设置为 true 时，仅对等双栈 VNET 中的 IPv6 空间。

注意：虽然子网对等连接 (Subnet Peering) 在所有 Azure 区域可用，但仍需通过 [此表单](<https://forms.office.com/pages/responsepage.aspx?id=v4j5cvGGr0GRqy180BHbR4Qnh_A4SJlJmB_ayXa7POFUNzlOVDdXQlY5WUxHWkcyNTZPRFpQV01VUi4u&route=shorturl>) 进行订阅允许列表。请阅读表单中的第 11 点并注意相关警告。

## 分段

此命令将 vnet-left 中的 subnet1 对等连接到 vnet-right 中的 subnet0 和 subnet2：

_az network vnet peering create -g sn-rg -n left0-right0 --vnet-name vnet-left --local-subnet-names subnet1 --remote-subnet-names subnet0 subnet2 --remote-vne vnet-right --peer-complete-vnets 0 --allow-vnet-access 1_

然后建立反方向对等连接：

_az network vnet peering create -g sn-rg -n right0-left0 --vnet-name vnet-right --local-subnet-names subnet0 subnet2 --remote-subnet-names subnet1 --remote-vne vnet-left --peer-complete-vnets 0 --allow-vnet-access 1_

这将使 vnet-left 中的 subnet0 和 subnet2，以及 vnet-right 中的 subnet1 断开连接，从而在对等 VNET 之间实现分段，而无需使用网络安全组 (NSGs)。

从 left 到 right 的对等连接细节如下。注意 localAddressSpace 和 remoteAddressSpace 前缀是本地和远程子网的对等前缀。其他方向类似，只是前缀交换。

_az network vnet peering show -g sn-rg -n left0-right0 --vnet-name vnet-left_
    
    {
      "allowForwardedTraffic": false,
      "allowGatewayTransit": false,
      "allowVirtualNetworkAccess": true,
      "doNotVerifyRemoteGateways": false,
      "etag": "W/\"6a80a7da-36f4-404c-8bd8-d23e1b2bdd9a\"",
      "id": "/subscriptions/7cb39d93-f8a1-48a7-af6d-c8e12136f0ad/resourceGroups/sn-rg/providers/Microsoft.Network/virtualNetworks/vnet-left/virtualNetworkPeerings/left0-right0",
      "localAddressSpace": {
        "addressPrefixes": [
          "10.0.1.0/24"
        ]
      },
      "localSubnetNames": [
        "subnet1"
      ],
      "localVirtualNetworkAddressSpace": {
        "addressPrefixes": [
          "10.0.1.0/24"
        ]
      },
      "name": "left0-right0",
      "peerCompleteVnets": false,
      "peeringState": "Connected",
      "peeringSyncLevel": "FullyInSync",
      "provisioningState": "Succeeded",
      "remoteAddressSpace": {
        "addressPrefixes": [
          "10.1.0.0/24",
          "10.1.2.0/24"
        ]
      },
      "remoteSubnetNames": [
        "subnet0",
        "subnet2"
      ],
      "remoteVirtualNetwork": {
        "id": "/subscriptions/7cb39d93-f8a1-48a7-af6d-c8e12136f0ad/resourceGroups/sn-rg/providers/Microsoft.Network/virtualNetworks/vnet-right",
        "resourceGroup": "sn-rg"
      },
      "remoteVirtualNetworkAddressSpace": {
        "addressPrefixes": [
          "10.1.0.0/24",
          "10.1.2.0/24"
        ]
      },
      "remoteVirtualNetworkEncryption": {
        "enabled": false,
        "enforcement": "AllowUnencrypted"
      },
      "resourceGroup": "sn-rg",
      "resourceGuid": "eb63ec9e-aa48-023e-1514-152f8ab39ae7",
      "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
      "useRemoteGateways": false
    }

在门户中，这些对等连接显示为“正常”VNET 对等连接，因为子网对等连接 (Subnet Peering) 尚未受支持。

![](https://techcommunity.microsoft.com/t5/s/gxcuf89792/images/bS00Mzk3NjQwLUEwTmRUdw?image-dimensions=750x750&revision=6)

唯一指示这不是完整 VNET 对等连接的标志是已对等 IP 地址空间——这是远程子网的子网 IP 范围。

![](https://techcommunity.microsoft.com/t5/s/gxcuf89792/images/bS00Mzk3NjQwLVpSNUI5Qg?image-dimensions=750x750&revision=6)

检查 vm left-1 的有效路由显示它有 subnet0 和 subnet2 的路由，但没有 vnet-right 中的 subnet1：

_az network nic show-effective-route-table -g sn-rg -n left-1701 -o table_
    
    Source    State    Address Prefix    Next Hop Type    Next Hop IP
    --------  -------  ----------------  ---------------  -------------
    Default   Active   10.0.0.0/16       VnetLocal
    Default   Active   172.16.0.0/24     VnetLocal
    Default   Active   10.1.0.0/24       VNetPeering
    Default   Active   10.1.2.0/24       VNetPeering
    Default   Active   0.0.0.0/0         Internet

注意，vm left-0 和 left-1 也有 vnet-right 中相同子网的路由，即使它们的子网未在 _\--local-subnet-names_ 参数中列出：

_az network nic show-effective-route-table -g sn-rg -n left-0681 -o table_
    
    Source    State    Address Prefix    Next Hop Type    Next Hop IP
    --------  -------  ----------------  ---------------  -------------
    Default   Active   10.0.0.0/16       VnetLocal
    Default   Active   172.16.0.0/24     VnetLocal
    Default   Active   10.1.0.0/24       VNetPeering
    Default   Active   10.1.2.0/24       VNetPeering
    Default   Active   0.0.0.0/0         Internet

_az network nic show-effective-route-table -g sn-rg -n left-2809 -o table_
    
    Source    State    Address Prefix    Next Hop Type    Next Hop IP
    --------  -------  ----------------  ---------------  -------------
    Default   Active   10.0.0.0/16       VnetLocal
    Default   Active   172.16.0.0/24     VnetLocal
    Default   Active   10.1.0.0/24       VNetPeering
    Default   Active   10.1.2.0/24       VNetPeering
    Default   Active   0.0.0.0/0         Internet

在当前版本中，_--remote-subnet-names_ 中列出的子网的 IP 空间会传播到本地 VNET 中的所有子网，而不仅仅是 _--local-subnet-names_ 中列出的子网。

然而，vnet-right 中的子网只传播了 vnet-left 中的 subnet1 的地址空间，如右边 VM 的有效路由所示：

_az network nic show-effective-route-table -g sn-rg -n right-0814 -o table_
    
    Source    State    Address Prefix    Next Hop Type    Next Hop IP
    --------  -------  ----------------  ---------------  -------------
    Default   Active   10.1.0.0/16       VnetLocal
    Default   Active   172.16.0.0/24     VnetLocal
    Default   Active   10.0.1.0/24       VNetPeering
    Default   Active   0.0.0.0/0         Internet

_az network nic show-effective-route-table -g sn-rg -n right-159 -o table_
    
    Source    State    Address Prefix    Next Hop Type    Next Hop IP
    --------  -------  ----------------  ---------------  -------------
    Default   Active   10.1.0.0/16       VnetLocal
    Default   Active   172.16.0.0/24     VnetLocal
    Default   Active   10.0.1.0/24       VNetPeering
    Default   Active   0.0.0.0/0         Internet

_az network nic show-effective-route-table -g sn-rg -n right-2283 -o table_
    
    Source    State    Address Prefix    Next Hop Type    Next Hop IP
    --------  -------  ----------------  ---------------  -------------
    Default   Active   10.1.0.0/16       VnetLocal
    Default   Active   172.16.0.0/24     VnetLocal
    Default   Active   10.0.1.0/24       VNetPeering
    Default   Active   0.0.0.0/0         Internet

因此，双向路由仅存在于 vnet-left 中的 subnet1 和 vnet-right 中的 subnet0 及 subnet2 之间，如预期：

![](https://techcommunity.microsoft.com/t5/s/gxcuf89792/images/bS00Mzk3NjQwLU1tU1FzNw?image-dimensions=750x750&revision=6)

通过从 left-1 到右边 VM 的 ping 测试来演示：
    
    to right-0:
    PING 10.1.0.4 (10.1.0.4) 56(84) bytes of data.
    64 bytes from 10.1.0.4: icmp_seq=1 ttl=64 time=1.20 ms
    64 bytes from 10.1.0.4: icmp_seq=2 ttl=64 time=1.24 ms
    64 bytes from 10.1.0.4: icmp_seq=3 ttl=64 time=1.06 ms
    64 bytes from 10.1.0.4: icmp_seq=4 ttl=64 time=1.56 ms
    ^C
    --- 10.1.0.4 ping statistics ---
    4 packets transmitted, 4 received, 0% packet loss, time 3005ms
    
    to right-1:
    PING 10.1.1.4 (10.1.1.4) 56(84) bytes of data.
    ^C
    --- 10.1.1.4 ping statistics ---
    5 packets transmitted, 0 received, 100% packet loss, time 4131ms
    
    to right-2:
    PING 10.1.2.4 (10.1.2.4) 56(84) bytes of data.
    64 bytes from 10.1.2.4: icmp_seq=1 ttl=64 time=3.39 ms
    64 bytes from 10.1.2.4: icmp_seq=2 ttl=64 time=0.968 ms
    64 bytes from 10.1.2.4: icmp_seq=3 ttl=64 time=3.00 ms
    64 bytes from 10.1.2.4: icmp_seq=4 ttl=64 time=2.47 ms
    ^C
    --- 10.1.2.4 ping statistics ---
    4 packets transmitted, 4 received, 0% packet loss, time 3005ms

## 重叠 IP 空间

现在，我们在两个 VNET 中添加重叠 IP 空间。

移除对等连接后，我们向每个 VNET 添加 172.16.0.0/16，创建 subnet3（使用 172.16.3.0/24），并插入一个 VM。

尝试对等完整 VNET 时，会因地址空间重叠而出错：

_az network vnet peering create -g sn-rg -n left0-right0 --vnet-name vnet-left --remote-vnet vnet-right --peer-complete-vnets 1 --allow-vnet-access 1_
    
    (VnetAddressSpacesOverlap) Cannot create or update peering /subscriptions/7cb39d93-f8a1-48a7-af6d-c8e12136f0ad/resourceGroups/sn-rg/providers/Microsoft.Network/virtualNetworks/vnet-left/virtualNetworkPeerings/left0-right0. Virtual networks /subscriptions/7cb39d93-f8a1-48a7-af6d-c8e12136f0ad/resourceGroups/sn-rg/providers/Microsoft.Network/virtualNetworks/vnet-left and /subscriptions/7cb39d93-f8a1-48a7-af6d-c8e12136f0ad/resourceGroups/sn-rg/providers/Microsoft.Network/virtualNetworks/vnet-right cannot be peered because their address spaces overlap. Overlapping address prefixes: 172.16.0.0/16, 172.16.0.0/16
    Code: VnetAddressSpacesOverlap

![](https://techcommunity.microsoft.com/t5/s/gxcuf89792/images/bS00Mzk3NjQwLVJlcTNlQw?image-dimensions=750x750&revision=6)

现在，我们像前一节一样重新建立子网级别对等连接：

_az network vnet peering create -g sn-rg -n left0-right0 --vnet-name vnet-left --local-subnet-names subnet1 --remote-subnet-names subnet0 subnet2 --remote-vne vnet-right --peer-complete-vnets 0 --allow-vnet-access 1_

_az network vnet peering create -g sn-rg -n right0-left0 --vnet-name vnet-right --local-subnet-names subnet0 subnet2 --remote-subnet-names subnet1 --remote-vne vnet-left --peer-complete-vnets 0 --allow-vnet-access 1_

尽管存在重叠地址空间，此操作成功完成。

_az network vnet peering show -g sn-rg -n left0-right0 --vnet-name vnet-left --query "[provisioningState, remoteAddressSpace]"_
    
    [
      "Succeeded",
      {
        "addressPrefixes": [
          "10.1.0.0/24",
          "10.1.2.0/24"
        ]
      }
    ]

_az network vnet peering show -g sn-rg -n right0-left0 --vnet-name vnet-right --query "[provisioningState, remoteAddressSpace]"_
    
    [
      "Succeeded",
      {
        "addressPrefixes": [
          "10.0.1.0/24"
        ]
      }
    ]

![](https://techcommunity.microsoft.com/t5/s/gxcuf89792/images/bS00Mzk3NjQwLXZSY3Fyag?image-dimensions=750x750&revision=6)

现在，我们尝试将 vnet-left 中的 subnet3（它与右边的 subnet3 重叠）包含在对等连接中：

_az network vnet peering create -g sn-rg -n left0-right0 --vnet-name vnet-left --local-subnet-names subnet1 subnet3 --remote-subnet-names subnet0 subnet2 --remote-vne vnet-right --peer-complete-vnets 0 --allow-vnet-access 1_
    
    (VnetAddressSpacesOverlap) Cannot create or update peering /subscriptions/7cb39d93-f8a1-48a7-af6d-c8e12136f0ad/resourceGroups/sn-rg/providers/Microsoft.Network/virtualNetworks/vnet-left/virtualNetworkPeerings/left0-right0. Virtual networks /subscriptions/7cb39d93-f8a1-48a7-af6d-c8e12136f0ad/resourceGroups/sn-rg/providers/Microsoft.Network/virtualNetworks/vnet-left and /subscriptions/7cb39d93-f8a1-48a7-af6d-c8e12136f0ad/resourceGroups/sn-rg/providers/Microsoft.Network/virtualNetworks/vnet-right cannot be peered because their address spaces overlap. Overlapping address prefixes: 172.16.3.0/24
    Code: VnetAddressSpacesOverlap

这证明子网对等连接 (Subnet Peering) 允许部分对等包含重叠 IP 空间的 VNET。

如所讨论，这在私有 IP 空间短缺的场景中非常有用。

# 展望未来

子网对等连接 (Subnet Peering) 现已在所有 Azure 区域可用：欢迎测试、实验并在生产环境中使用。

该功能目前仅通过最新版本的 [Azure CLI](<https://learn.microsoft.com/en-us/cli/azure/network/vnet/peering?view=azure-cli-latest>)、[Bicep](<https://learn.microsoft.com/en-us/azure/templates/microsoft.network/virtualnetworks/virtualnetworkpeerings?pivots=deployment-language-bicep>)、[ARM Template](<https://learn.microsoft.com/en-us/azure/templates/microsoft.network/virtualnetworks/virtualnetworkpeerings?pivots=deployment-language-arm-template>)、[Terraform](<https://learn.microsoft.com/en-us/azure/templates/microsoft.network/virtualnetworks/virtualnetworkpeerings?pivots=deployment-language-terraform>) 和 PowerShell 可用。门户支持即将添加。

有意义的下一步是将在子网对等连接 (Subnet Peering) 集成到 Azure 虚拟网络管理器 (Azure Virtual Network Manager, AVNM) 和虚拟广域网 (Virtual WAN) 中，从而在企业规模的网络基础架构中利用其优势。

我将继续跟踪发展和更新此文章。

更新于 2025 年 3 月 26 日

版本 2.0

<!-- AI_TASK_END: AI全文翻译 -->

